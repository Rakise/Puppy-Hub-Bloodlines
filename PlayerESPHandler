-- PlayerESPHandler.lua
-- FIX: Increased Size and Visibility (Anti-Gank)
-- FIX: Throttled Data Fetch

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")

local PlayerESPHandler = {}
PlayerESPHandler.__index = PlayerESPHandler

local SETTINGS_FOLDER = ReplicatedStorage:WaitForChild("Settings", 10)

function PlayerESPHandler.new()
    local self = setmetatable({}, PlayerESPHandler)
    self.enabled = false
    self.billboards = {}
    self.dataCache = {} 
    self.connections = {}
    self.maxDistance = 4000 -- Increased default distance
    return self
end

function PlayerESPHandler:GetPlayerData(player)
    local now = tick()
    if self.dataCache[player] and (now - self.dataCache[player].LastUpdate < 0.5) then
        return self.dataCache[player].Weapon, self.dataCache[player].IsObserving
    end

    local weapon = "None"
    local isObserving = false
    
    if SETTINGS_FOLDER then
        local playerSettings = SETTINGS_FOLDER:FindFirstChild(player.Name)
        if playerSettings then
            local wVal = playerSettings:FindFirstChild("CurrentWeapon")
            if wVal then weapon = wVal.Value end
            local sVal = playerSettings:FindFirstChild("CurrentSkill")
            if sVal and type(sVal.Value) == "string" and string.find(string.lower(sVal.Value), "sense") then
                isObserving = true
            end
        end
    end
    
    self.dataCache[player] = { Weapon = weapon, IsObserving = isObserving, LastUpdate = now }
    return weapon, isObserving
end

function PlayerESPHandler:CreateBillboard(player)
    if self.billboards[player] then self.billboards[player]:Destroy() end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "PuppyESP_" .. player.Name
    -- Increased size for better visibility
    billboard.Size = UDim2.new(0, 250, 0, 70) 
    billboard.StudsOffset = Vector3.new(0, 4, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = CoreGui 
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0.4, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextStrokeTransparency = 0.3
    nameLabel.Font = Enum.Font.GothamBold -- Thicker font
    nameLabel.TextSize = 18 -- Bigger text
    nameLabel.Text = player.Name
    nameLabel.Parent = billboard
    
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(1, 0, 0.4, 0)
    infoLabel.Position = UDim2.new(0, 0, 0.4, 0)
    infoLabel.BackgroundTransparency = 1
    infoLabel.TextColor3 = Color3.new(0.9, 0.9, 0.9)
    infoLabel.TextStrokeTransparency = 0.3
    infoLabel.Font = Enum.Font.GothamSemibold
    infoLabel.TextSize = 14 -- Bigger info text
    infoLabel.Text = "..."
    infoLabel.Parent = billboard
    
    self.billboards[player] = {
        gui = billboard,
        nameLbl = nameLabel,
        infoLbl = infoLabel
    }
end

function PlayerESPHandler:Update()
    if not self.enabled then return end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if not self.billboards[player] then self:CreateBillboard(player) end
            
            local data = self.billboards[player]
            local char = player.Character
            local hrp = char.HumanoidRootPart
            local hum = char:FindFirstChild("Humanoid")
            
            data.gui.Adornee = hrp
            
            local weapon, isObserving = self:GetPlayerData(player)
            local hp = hum and math.floor(hum.Health) or 0
            local maxHp = hum and math.floor(hum.MaxHealth) or 100
            local dist = math.floor((Players.LocalPlayer.Character.HumanoidRootPart.Position - hrp.Position).Magnitude)
            
            local color = isObserving and Color3.fromRGB(0, 220, 255) or Color3.fromRGB(255, 255, 255)
            if dist < 100 then color = Color3.fromRGB(255, 50, 50) end -- Red warning if close
            
            data.nameLbl.TextColor3 = color
            data.nameLbl.Text = string.format("%s [%dm]", player.Name, dist)
            
            data.infoLbl.TextColor3 = color
            data.infoLbl.Text = string.format("HP: %d/%d\nWep: %s", hp, maxHp, weapon)
            
            data.gui.Enabled = dist < self.maxDistance
        else
            if self.billboards[player] then
                self.billboards[player].gui.Adornee = nil
                self.billboards[player].gui.Enabled = false
            end
        end
    end
end

function PlayerESPHandler:enable()
    if self.enabled then return end
    self.enabled = true
    self.connections.Update = RunService.RenderStepped:Connect(function() self:Update() end)
    self.connections.PlayerRem = Players.PlayerRemoving:Connect(function(p)
        if self.billboards[p] then
            self.billboards[p].gui:Destroy()
            self.billboards[p] = nil
        end
        self.dataCache[p] = nil
    end)
end

function PlayerESPHandler:disable()
    self.enabled = false
    if self.connections.Update then self.connections.Update:Disconnect() end
    if self.connections.PlayerRem then self.connections.PlayerRem:Disconnect() end
    for _, b in pairs(self.billboards) do b.gui:Destroy() end
    self.billboards = {}
    self.dataCache = {}
end

return PlayerESPHandler