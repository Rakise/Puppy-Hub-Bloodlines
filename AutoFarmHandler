-- AutoFarmHandler.lua
-- Handles Fruit Summoning Macro and Auto Pickup
-- OPTIMIZED: Uses caching to prevent FPS drops (No longer scans workspace every loop)
-- Removed VirtualInputManager as requested

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local AutoFarmHandler = {}
AutoFarmHandler.__index = AutoFarmHandler

-- Settings accessed by CoreManager
AutoFarmHandler.Settings = {
    AutoPickup = false,
    AutoSummon = false,
    PickupRange = 50,
    PickupDelay = 0.3
}

local State = {
    PickupCache = {}, -- Stores valid items so we don't scan workspace repeatedly
    Connections = {},
    SummonThread = nil,
    PickupThread = nil
}

-- ============================================================================
-- CACHE & TRACKING LOGIC (OPTIMIZATION)
-- ============================================================================

local function isValidPickup(obj)
    -- Fast checks first
    if not obj:IsA("BasePart") then return false end
    
    -- Check for required children
    if obj:FindFirstChild("Pickupable") and obj:FindFirstChild("ID") then
        return true
    end
    return false
end

local function addToCache(child)
    if isValidPickup(child) then
        State.PickupCache[child] = true
    end
end

local function startTracking()
    if State.Connections.Tracking then return end -- Already tracking

    -- 1. Initial Scan (Do this ONCE, not every loop)
    task.spawn(function()
        for _, child in ipairs(Workspace:GetChildren()) do
            addToCache(child)
        end
    end)

    -- 2. Listen for new items dropping
    State.Connections.Tracking = Workspace.ChildAdded:Connect(function(child)
        -- Wait briefly for attributes/children (like ID) to replicate
        task.delay(0.5, function()
            if child.Parent then -- Ensure it wasn't deleted immediately
                addToCache(child)
            end
        end)
    end)

    -- 3. Cleanup items when they are removed
    State.Connections.Removing = Workspace.ChildRemoved:Connect(function(child)
        if State.PickupCache[child] then
            State.PickupCache[child] = nil
        end
    end)
end

local function stopTracking()
    if State.Connections.Tracking then State.Connections.Tracking:Disconnect() end
    if State.Connections.Removing then State.Connections.Removing:Disconnect() end
    State.Connections = {}
    State.PickupCache = {}
end

-- ============================================================================
-- AUTO PICKUP LOOP
-- ============================================================================

local function doPickup()
    local character = LocalPlayer.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if not dataEvent then return end

    local range = AutoFarmHandler.Settings.PickupRange

    -- Iterate ONLY the cached items (Efficiency: High)
    for item, _ in pairs(State.PickupCache) do
        if not AutoFarmHandler.Settings.AutoPickup then break end

        if item.Parent then
            local dist = (root.Position - item.Position).Magnitude
            if dist <= range then
                if item:FindFirstChild("ID") then
                    dataEvent:FireServer('PickUp', item.ID.Value)
                    -- Wait here to prevent spamming remote too fast
                    task.wait(AutoFarmHandler.Settings.PickupDelay)
                end
            end
        else
            -- Cleanup stale reference
            State.PickupCache[item] = nil
        end
    end
end

function AutoFarmHandler.togglePickup(val)
    AutoFarmHandler.Settings.AutoPickup = val
    
    if State.PickupThread then
        task.cancel(State.PickupThread)
        State.PickupThread = nil
    end

    if val then
        startTracking() -- Enable the event listeners
        State.PickupThread = task.spawn(function()
            while AutoFarmHandler.Settings.AutoPickup do
                doPickup()
                task.wait(0.3) -- Loop speed
            end
            stopTracking() -- Clean up when loop finishes
        end)
    else
        stopTracking()
    end
end

-- ============================================================================
-- AUTO SUMMON MACRO
-- ============================================================================

local function getCooldownsFolder()
    local cooldowns = ReplicatedStorage:FindFirstChild("Cooldowns")
    if cooldowns then
        return cooldowns:FindFirstChild(LocalPlayer.Name)
    end
    return nil
end

local function clickSkillSlot()
    local clientGui = PlayerGui:FindFirstChild("ClientGui")
    if not clientGui then return false end
    
    local mainframe = clientGui:FindFirstChild("Mainframe")
    if not mainframe then return false end
    
    local loadout = mainframe:FindFirstChild("Loadout")
    if not loadout then return false end
    
    for _, slot in ipairs(loadout:GetChildren()) do
        if slot:IsA("ImageButton") and (string.find(slot.Name, "Slot") then
            local slotText = slot:FindFirstChild("SlotText")
            if slotText and string.find(string.lower(slotText.Text), "fruit summoning") then
                
                -- 1. Equip Slot
                if firesignal then
                    firesignal(slot.MouseButton1Up)
                end
                
                task.wait(0.2)
                
                -- 2. Use Skill
                if mouse1click then
                    mouse1click()
                end
                
                return true
            end
        end
    end
    return false
end

local function summonLoop()
    while AutoFarmHandler.Settings.AutoSummon do
        local success = clickSkillSlot()
        
        if success then
            -- Wait logic for cooldown
            local cooldowns = getCooldownsFolder()
            local skillCooldown = nil
            local t = 0
            
            -- Wait for cooldown to appear (Validation that skill was used)
            while t < 5 do
                if cooldowns then
                    for _, cd in ipairs(cooldowns:GetChildren()) do
                        if string.find(string.lower(cd.Name), "fruit summoning") then
                            skillCooldown = cd
                            break
                        end
                    end
                end
                if skillCooldown then break end
                t = t + 0.5
                task.wait(0.5)
            end
            
            -- Wait for cooldown to finish
            if skillCooldown then
                while skillCooldown.Parent do
                    task.wait(0.5)
                    if not AutoFarmHandler.Settings.AutoSummon then return end
                end
                task.wait(0.5) 
            else
                task.wait(2)
            end
        else
            -- Slot not found or UI not ready
            task.wait(2)
        end
    end
end

function AutoFarmHandler.toggleSummon(val)
    AutoFarmHandler.Settings.AutoSummon = val
    
    if State.SummonThread then
        task.cancel(State.SummonThread)
        State.SummonThread = nil
    end
    
    if val then
        if not AutoFarmHandler.Settings.AutoPickup then
            AutoFarmHandler.togglePickup(true)
        end
        State.SummonThread = task.spawn(summonLoop)
    end
end

return AutoFarmHandler