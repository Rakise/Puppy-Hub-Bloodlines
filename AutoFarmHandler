-- AutoFarmHandler.lua
-- Handles Fruit Summoning Macro and Auto Pickup
-- OPTIMIZED: Uses caching to prevent FPS drops
-- UPDATED: Fixed Recast Delay & Server Hop Crash
-- EXPOSED: Safety Check & Server Hop for CoreManager

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local AutoFarmHandler = {}
AutoFarmHandler.__index = AutoFarmHandler

AutoFarmHandler.Settings = {
    AutoPickup = false,
    AutoSummon = false,
    PickupRange = 50,
    PickupDelay = 0.3,
    ServerHopOnDanger = true, 
    DangerRadius = 300
}

local SETTINGS_FOLDER = ReplicatedStorage:FindFirstChild("Settings")
local GAME_ID = 10266164381

local State = {
    PickupCache = {},
    Connections = {},
    SummonThread = nil,
    PickupThread = nil,
    SafetyThread = nil,
    IsDefending = false,
    IsHopping = false
}

-- ============================================================================
-- EXPOSED FUNCTIONS (For CoreManager)
-- ============================================================================

function AutoFarmHandler.checkSafety()
    -- Returns: isSafe (bool), reason (string/nil)
    local myChar = LocalPlayer.Character
    local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myRoot then return true, nil end -- Can't check if not spawned

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            -- 1. Distance
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local dist = (player.Character.HumanoidRootPart.Position - myRoot.Position).Magnitude
                if dist <= AutoFarmHandler.Settings.DangerRadius then
                    return false, "Player Nearby (" .. player.Name .. ")"
                end
            end
            -- 2. Chakra Sense (Replicated)
            if SETTINGS_FOLDER then
                local pSettings = SETTINGS_FOLDER:FindFirstChild(player.Name)
                if pSettings then
                    local sVal = pSettings:FindFirstChild("CurrentSkill")
                    if sVal and type(sVal.Value) == "string" and string.find(string.lower(sVal.Value), "sense") then
                        return false, "Chakra Sense (" .. player.Name .. ")"
                    end
                end
            end
            -- 3. Chakra Sense (Tool)
            if player.Character then
                for _, tool in ipairs(player.Character:GetChildren()) do
                    if tool:IsA("Tool") and string.find(string.lower(tool.Name), "sense") then
                        return false, "Chakra Sense Tool (" .. player.Name .. ")"
                    end
                end
            end
        end
    end
    return true, nil
end

-- ============================================================================
-- HTTP SERVER HOP (Fixed: Limit 10)
-- ============================================================================
local ServerHop = {}

function ServerHop.join(serverId)
    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if dataEvent then
        print("[AutoFarm] Firing ServerTeleport to: " .. tostring(serverId))
        dataEvent:FireServer("ServerTeleport", serverId, 14)
    end
end

function ServerHop.fetchServers()
    local allServers = {}
    -- FIX: Limit set to 10 to prevent crash
    local url = string.format("https://roproxy-production-0200.up.railway.app/games/v1/games/%d/servers/0?sortOrder=2&excludeFullGames=false&limit=10", GAME_ID)
    
    local success, response = pcall(function()
        local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
        if requestFunc then return requestFunc({Url = url, Method = "GET"}).Body else return game:HttpGet(url) end
    end)

    if success and response then
        local jsonSuccess, data = pcall(HttpService.JSONDecode, HttpService, response)
        if jsonSuccess and data and data.data then
            for _, s in ipairs(data.data) do table.insert(allServers, s) end
        end
    end
    return allServers
end

function ServerHop.execute()
    if State.IsHopping then return end
    State.IsHopping = true
    print("[AutoFarm] Initiating Hop...")

    task.spawn(function()
        local servers = ServerHop.fetchServers()
        if #servers > 0 then
            local candidates = {}
            for _, s in ipairs(servers) do
                if s.playing and s.maxPlayers and s.id ~= game.JobId then
                    if s.playing >= 5 and s.playing < (s.maxPlayers - 2) then
                        table.insert(candidates, s)
                    end
                end
            end
            
            if #candidates > 0 then
                local target = candidates[math.random(1, #candidates)]
                ServerHop.join(target.id)
            else
                print("[AutoFarm] No suitable servers found.")
            end
        end
        task.wait(2)
        State.IsHopping = false
    end)
end

AutoFarmHandler.executeServerHop = ServerHop.execute

-- ============================================================================
-- SUMMON MACRO (Fixed Recast)
-- ============================================================================

local function getCooldownsFolder()
    local cooldowns = ReplicatedStorage:FindFirstChild("Cooldowns")
    if cooldowns then return cooldowns:FindFirstChild(LocalPlayer.Name) end
    return nil
end

local function clickSkillSlot()
    local clientGui = PlayerGui:FindFirstChild("ClientGui")
    if not clientGui then return false end
    local mainframe = clientGui:FindFirstChild("Mainframe")
    if not mainframe then return false end
    local loadout = mainframe:FindFirstChild("Loadout")
    if not loadout then return false end
    
    for _, slot in ipairs(loadout:GetChildren()) do
        if slot:IsA("ImageButton") and (string.find(slot.Name, "Slot") or string.find(slot.Name, "Key")) then
            local slotText = slot:FindFirstChild("SlotText")
            if slotText and string.find(string.lower(slotText.Text), "fruit summoning") then
                if firesignal then
                    firesignal(slot.MouseButton1Down)
                    task.wait(0.05)
                    firesignal(slot.MouseButton1Up)
                end
                task.wait(0.3)
                if mouse1click then mouse1click() end
                return true
            end
        end
    end
    return false
end

local function summonLoop()
    while AutoFarmHandler.Settings.AutoSummon do
        if State.IsDefending or State.IsHopping then task.wait(0.5) continue end

        local success = clickSkillSlot()
        
        if success then
            local cooldowns = getCooldownsFolder()
            local skillCooldown = nil
            local t = 0
            -- Wait for cooldown to appear
            while t < 5 do
                if cooldowns then
                    for _, cd in ipairs(cooldowns:GetChildren()) do
                        if string.find(string.lower(cd.Name), "fruit summoning") then
                            skillCooldown = cd 
                            break
                        end
                    end
                end
                if skillCooldown then break end
                t = t + 0.5
                task.wait(0.5)
            end
            
            if skillCooldown then
                -- Wait for cooldown to finish
                while skillCooldown.Parent do
                    task.wait(0.5)
                    if not AutoFarmHandler.Settings.AutoSummon then return end
                end
                -- FIX: Extra buffer for server processing
                task.wait(1.5) 
            else
                -- Click likely failed or cooldown glitch
                task.wait(2)
            end
        else
            task.wait(2)
        end
    end
end

-- ... (Include existing Auto Pickup, Clay Doll Defense logic here as previously defined) ...
-- Re-adding Pickup Logic for completeness of the file
local function isValidPickup(obj)
    local detector = obj:FindFirstChild("ItemDetector")
    if detector and detector:IsA("ClickDetector") then return true end
    return false
end
local function addToCache(child) if isValidPickup(child) then State.PickupCache[child] = true end end

local function startTracking()
    task.spawn(function() for _, child in ipairs(Workspace:GetChildren()) do addToCache(child) end end)
    State.Connections.Tracking = Workspace.ChildAdded:Connect(function(child) task.delay(0.5, function() if child.Parent then addToCache(child) end end) end)
    State.Connections.Removing = Workspace.ChildRemoved:Connect(function(child) if State.PickupCache[child] then State.PickupCache[child] = nil end end)
end
local function stopTracking()
    if State.Connections.Tracking then State.Connections.Tracking:Disconnect() end
    if State.Connections.Removing then State.Connections.Removing:Disconnect() end
    State.Connections = {} State.PickupCache = {}
end

local function doPickup()
    if State.IsDefending or State.IsHopping then return end
    local character = LocalPlayer.Character
    local root = character and character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    local range = AutoFarmHandler.Settings.PickupRange
    for item, _ in pairs(State.PickupCache) do
        if not AutoFarmHandler.Settings.AutoPickup then break end
        if item.Parent then
            local itemPos = nil
            if item:IsA("BasePart") then itemPos = item.Position elseif item:IsA("Model") then itemPos = item:GetPivot().Position end
            if itemPos and (root.Position - itemPos).Magnitude <= range then
                local detector = item:FindFirstChild("ItemDetector")
                if detector and detector:IsA("ClickDetector") then
                    if fireclickdetector then fireclickdetector(detector, (root.Position - itemPos).Magnitude) end
                    task.wait(AutoFarmHandler.Settings.PickupDelay)
                end
            end
        else State.PickupCache[item] = nil end
    end
end

function AutoFarmHandler.togglePickup(val)
    AutoFarmHandler.Settings.AutoPickup = val
    if State.PickupThread then task.cancel(State.PickupThread) State.PickupThread = nil end
    if val then
        startTracking()
        State.PickupThread = task.spawn(function()
            while AutoFarmHandler.Settings.AutoPickup do doPickup() task.wait(0.3) end
            stopTracking()
        end)
    else stopTracking() end
end

function AutoFarmHandler.toggleSummon(val)
    AutoFarmHandler.Settings.AutoSummon = val
    if State.SummonThread then task.cancel(State.SummonThread) State.SummonThread = nil end
    if val then
        if not AutoFarmHandler.Settings.AutoPickup then AutoFarmHandler.togglePickup(true) end
        -- Start safety watcher (Internal or external, CoreManager now handles main safety check on join)
        -- But we need a loop for runtime safety
        if State.SafetyThread then task.cancel(State.SafetyThread) end
        State.SafetyThread = task.spawn(function()
            while AutoFarmHandler.Settings.AutoSummon do
                local safe, _ = AutoFarmHandler.checkSafety()
                if not safe and AutoFarmHandler.Settings.ServerHopOnDanger then
                    AutoFarmHandler.executeServerHop()
                    break
                end
                task.wait(1)
            end
        end)
        
        -- Start Summon Loop
        State.SummonThread = task.spawn(summonLoop)
    else
        if State.SafetyThread then task.cancel(State.SafetyThread) State.SafetyThread = nil end
    end
end

return AutoFarmHandler