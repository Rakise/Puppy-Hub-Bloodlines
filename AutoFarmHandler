-- AutoFarmHandler.lua
-- Handles Fruit Summoning Macro and Auto Pickup
-- Removed VirtualInputManager as requested
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local AutoFarmHandler = {}
AutoFarmHandler.__index = AutoFarmHandler

-- Settings accessed by CoreManager
AutoFarmHandler.Settings = {
    AutoPickup = false,
    AutoSummon = false,
    PickupRange = 50,
    PickupDelay = 0.3
}

local State = {
    PickupList = {},
    Connections = {},
    SummonThread = nil,
    PickupThread = nil
}

-- ============================================================================
-- AUTO PICKUP LOGIC
-- ============================================================================
local function isValidPickup(obj)
    return obj:IsA("BasePart") 
        and obj:FindFirstChild("Pickupable") 
        and obj:FindFirstChild("ID")
end

local function doPickup()
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local items = {}
    for _, child in ipairs(Workspace:GetChildren()) do
        if isValidPickup(child) then
            table.insert(items, child)
        end
    end

    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if not dataEvent then return end

    for _, item in ipairs(items) do
        if not AutoFarmHandler.Settings.AutoPickup then break end
        
        local rootNow = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not rootNow then break end
        
        local dist = (rootNow.Position - item.Position).Magnitude
        if dist <= AutoFarmHandler.Settings.PickupRange then
            if item:FindFirstChild("ID") then
                dataEvent:FireServer('PickUp', item.ID.Value)
                task.wait(AutoFarmHandler.Settings.PickupDelay)
            end
        end
    end
end

function AutoFarmHandler.togglePickup(val)
    AutoFarmHandler.Settings.AutoPickup = val
    
    if State.PickupThread then
        task.cancel(State.PickupThread)
        State.PickupThread = nil
    end

    if val then
        State.PickupThread = task.spawn(function()
            while AutoFarmHandler.Settings.AutoPickup do
                doPickup()
                task.wait(0.5) 
            end
        end)
    end
end

-- ============================================================================
-- AUTO SUMMON MACRO
-- ============================================================================
local function getCooldownsFolder()
    local cooldowns = ReplicatedStorage:FindFirstChild("Cooldowns")
    if cooldowns then
        return cooldowns:FindFirstChild(LocalPlayer.Name)
    end
    return nil
end

local function clickSkillSlot()
    local clientGui = PlayerGui:FindFirstChild("ClientGui")
    if not clientGui then return false end
    
    local mainframe = clientGui:FindFirstChild("Mainframe")
    if not mainframe then return false end
    
    local loadout = mainframe:FindFirstChild("Loadout")
    if not loadout then return false end
    
    for _, slot in ipairs(loadout:GetChildren()) do
        if slot:IsA("ImageButton") and (string.find(slot.Name, "Slot") or string.find(slot.Name, "Key")) then
            local slotText = slot:FindFirstChild("SlotText")
            if slotText and string.find(string.lower(slotText.Text), "fruit summoning") then
                
                -- 1. Equip Slot
                if firesignal then
                    firesignal(slot.MouseButton1Up)
                end
                
                task.wait(0.2)
                
                -- 2. Use Skill
                if mouse1click then
                    mouse1click()
                end
                
                return true
            end
        end
    end
    return false
end

local function summonLoop()
    while AutoFarmHandler.Settings.AutoSummon do
        local success = clickSkillSlot()
        
        if success then
            local cooldowns = getCooldownsFolder()
            local skillCooldown = nil
            local t = 0
            
            -- Wait for cooldown to appear
            while t < 5 do
                if cooldowns then
                    for _, cd in ipairs(cooldowns:GetChildren()) do
                        if string.find(string.lower(cd.Name), "fruit summoning") then
                            skillCooldown = cd
                            break
                        end
                    end
                end
                if skillCooldown then break end
                t = t + 0.5
                task.wait(0.5)
            end
            
            -- Wait for cooldown to finish
            if skillCooldown then
                while skillCooldown.Parent do
                    task.wait(0.5)
                    if not AutoFarmHandler.Settings.AutoSummon then return end
                end
                task.wait(0.5) 
            else
                task.wait(2)
            end
        else
            task.wait(2)
        end
    end
end

function AutoFarmHandler.toggleSummon(val)
    AutoFarmHandler.Settings.AutoSummon = val
    
    if State.SummonThread then
        task.cancel(State.SummonThread)
        State.SummonThread = nil
    end
    
    if val then
        if not AutoFarmHandler.Settings.AutoPickup then
            AutoFarmHandler.togglePickup(true)
        end
        State.SummonThread = task.spawn(summonLoop)
    end
end

return AutoFarmHandler