-- MobESPHandler.lua (Bloodlines Specific)
-- Handles NPC (Dialog) and Mob (Combat) ESP
-- OPTIMIZED: Event-based scanning with Dynamic Sizing

local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local MobESPHandler = {}
MobESPHandler.__index = MobESPHandler

-- Config
local COLORS = {
    NPC = Color3.fromRGB(255, 255, 0), -- Yellow
    MOB = Color3.fromRGB(255, 50, 50)  -- Red
}

function MobESPHandler.new()
    local self = setmetatable({}, MobESPHandler)
    self.showMobs = false
    self.showNPCs = false
    self.maxDistance = math.huge -- Default Infinite
    self.billboards = {} -- [Model] = BillboardGui
    self.connections = {}
    return self
end

function MobESPHandler:CreateBillboard(model, typeStr)
    if self.billboards[model] then return end
    
    local color = (typeStr == "NPC") and COLORS.NPC or COLORS.MOB
    
    -- Dynamic Scaling Calculation
    local height = 5 -- Default
    local extents = model:GetExtentsSize()
    if extents.Y > 1 then
        height = extents.Y
    end

    local bb = Instance.new("BillboardGui")
    bb.Name = "MobESP"
    -- Scale Billboard Size based on Model Height
    bb.Size = UDim2.new(0, 100 + (height * 2), 0, 40 + height)
    bb.StudsOffset = Vector3.new(0, height + 2, 0)
    bb.AlwaysOnTop = true
    bb.Parent = CoreGui
    bb.Adornee = model:FindFirstChild("HumanoidRootPart") or model.PrimaryPart
    
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, 0, 1, 0)
    lbl.BackgroundTransparency = 1
    lbl.TextColor3 = color
    lbl.TextStrokeTransparency = 0.3
    lbl.Font = Enum.Font.SourceSansBold
    -- Scale Text Size slightly for huge mobs
    lbl.TextSize = math.clamp(14 + (height * 0.5), 12, 24)
    lbl.Text = model.Name
    lbl.Parent = bb
    
    self.billboards[model] = {gui = bb, type = typeStr, lbl = lbl}
end

function MobESPHandler:CheckMob(model)
    if model:IsA("Model") and model:FindFirstChild("Humanoid") and not self.billboards[model] then
        -- Check for "NPC" StringValue
        local npcVal = model:FindFirstChild("NPC")
        if npcVal and npcVal:IsA("StringValue") then
            local val = npcVal.Value
            
            if val == "Dialog" then
                self:CreateBillboard(model, "NPC")
            elseif val == "Combat" then
                self:CreateBillboard(model, "MOB")
            end
        end
    end
end

function MobESPHandler:Scan()
    for _, model in ipairs(Workspace:GetChildren()) do
        self:CheckMob(model)
    end
end

function MobESPHandler:Update()
    local camPos = Workspace.CurrentCamera.CFrame.Position
    
    for model, data in pairs(self.billboards) do
        if not model.Parent then
            data.gui:Destroy()
            self.billboards[model] = nil
        else
            -- Visibility Check based on settings
            local isVisible = false
            if data.type == "NPC" and self.showNPCs then isVisible = true end
            if data.type == "MOB" and self.showMobs then isVisible = true end
            
            if isVisible then
                local part = data.gui.Adornee
                if part then
                    local dist = (part.Position - camPos).Magnitude
                    
                    -- Update Text with Distance/HP
                    local hum = model:FindFirstChild("Humanoid")
                    local hp = hum and math.floor(hum.Health) or 0
                    local maxHp = hum and math.floor(hum.MaxHealth) or 100
                    
                    -- Name matches type color, HP is white for readability against red mobs
                    local nameColorHex = data.type == "MOB" and "#FF3232" or "#FFFF00"
                    
                    data.lbl.Text = string.format(
                        "<font color='%s'>%s</font>\n<font color='#FFFFFF'>[%dm] HP: %d/%d</font>", 
                        nameColorHex, 
                        model.Name, 
                        dist, 
                        hp,
                        maxHp
                    )
                    data.lbl.RichText = true
                else
                    isVisible = false
                end
            end
            
            data.gui.Enabled = isVisible
        end
    end
end

function MobESPHandler:StartLoop()
    if self.connections.Update then return end
    
    self:Scan()
    
    self.connections.ChildAdded = Workspace.ChildAdded:Connect(function(child)
        task.wait(0.1) -- Wait briefly for NPC value to replicate
        self:CheckMob(child)
    end)
    
    -- Periodic Rescan (Fixes streaming issues or missing mobs)
    self.connections.Rescan = RunService.Heartbeat:Connect(function()
        if tick() % 2 < 0.1 then -- Runs roughly every 2 seconds
             self:Scan()
        end
    end)
    
    self.connections.Update = RunService.Heartbeat:Connect(function()
        self:Update()
    end)
end

function MobESPHandler:StopLoop()
    if self.connections.ChildAdded then self.connections.ChildAdded:Disconnect() self.connections.ChildAdded = nil end
    if self.connections.Update then self.connections.Update:Disconnect() self.connections.Update = nil end
    if self.connections.Rescan then self.connections.Rescan:Disconnect() self.connections.Rescan = nil end
    
    for _, data in pairs(self.billboards) do
        data.gui.Enabled = false
    end
end

function MobESPHandler:toggleMobs(val)
    self.showMobs = val
    if self.showMobs or self.showNPCs then self:StartLoop() else self:StopLoop() end
end

function MobESPHandler:toggleNPCs(val)
    self.showNPCs = val
    if self.showMobs or self.showNPCs then self:StartLoop() else self:StopLoop() end
end

function MobESPHandler:setMaxDistance(val)
    self.maxDistance = math.huge -- Always infinite now
end

return MobESPHandler