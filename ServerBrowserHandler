-- ServerBrowserHandler.lua
-- Replicates GuiHandler logic for Bloodlines
-- Sources data from ReplicatedStorage.Servers
-- FIX: ZIndex updated to 10

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local ServerBrowserHandler = {}
ServerBrowserHandler.__index = ServerBrowserHandler

function ServerBrowserHandler.new()
    local self = setmetatable({}, ServerBrowserHandler)
    self.container = nil
    self.serverButtons = {}
    
    self.serversFolder = ReplicatedStorage:WaitForChild("Servers", 5)
    self.eventsFolder = ReplicatedStorage:WaitForChild("Events", 5)
    
    return self
end

function ServerBrowserHandler:Initialize(containerFrame)
    self.container = containerFrame
    self:Refresh()
    
    if self.serversFolder then
        self.serversFolder.ChildAdded:Connect(function() 
             -- self:Refresh() -- Optional auto-refresh
        end)
    end
end

function ServerBrowserHandler:Clear()
    if not self.container then return end
    for _, btn in pairs(self.serverButtons) do
        btn:Destroy()
    end
    self.serverButtons = {}
    self.container.CanvasSize = UDim2.new(0, 0, 0, 0)
end

function ServerBrowserHandler:JoinServer(serverId)
    if not self.eventsFolder then return end
    local dataEvent = self.eventsFolder:FindFirstChild("DataEvent")
    if dataEvent and dataEvent:IsA("RemoteEvent") then
        dataEvent:FireServer("ServerTeleport", serverId, 14)
    else
        warn("DataEvent not found!")
    end
end

function ServerBrowserHandler:CreateServerButton(serverValueObj)
    if not self.container then return end
    if not serverValueObj:IsA("StringValue") then return end
    
    local rawValue = serverValueObj.Value
    local splitData = string.split(rawValue, ' ')
    local serverId = splitData[1]
    local playerCount = splitData[2] or "?"
    local serverName = serverValueObj.Name
    
    local region = "Unknown"
    local regionObj = serverValueObj:FindFirstChild("Region")
    if regionObj then region = regionObj.Value end
    
    local isCurrent = serverValueObj:FindFirstChild("Current") ~= nil
    local displayText = string.format("%s | %s | %s/20", serverName, region, playerCount)
    if isCurrent then displayText = "[Current] " .. displayText end
    
    local btn = Instance.new("TextButton")
    btn.Name = serverName
    btn.Size = UDim2.new(1, -4, 0, 30)
    btn.BackgroundColor3 = isCurrent and Color3.fromRGB(60, 80, 60) or Color3.fromRGB(40, 40, 40)
    btn.BorderColor3 = Color3.fromRGB(0, 0, 0)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Text = "  " .. displayText
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.Font = Enum.Font.SourceSansSemibold
    btn.TextSize = 14
    btn.ZIndex = 10 -- FIX: High ZIndex to ensure visibility
    btn.Parent = self.container
    
    local sortOrder = tonumber(playerCount) or 0
    btn.LayoutOrder = -sortOrder
    
    if not isCurrent then
        btn.MouseButton1Click:Connect(function()
            self:JoinServer(serverId)
        end)
    else
        btn.AutoButtonColor = false
        btn.TextTransparency = 0.5
    end
    
    table.insert(self.serverButtons, btn)
end

function ServerBrowserHandler:Refresh()
    self:Clear()
    if not self.serversFolder then return end
    
    local children = self.serversFolder:GetChildren()
    for _, child in ipairs(children) do
        pcall(function() self:CreateServerButton(child) end)
    end
    
    if self.container then
        local layout = self.container:FindFirstChildOfClass("UIListLayout")
        if layout then
            self.container.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        end
    end
end

function ServerBrowserHandler:Search(query)
    if not self.container then return end
    query = query:lower()
    local visibleCount = 0
    for _, btn in ipairs(self.serverButtons) do
        if query == "" or btn.Name:lower():find(query) then
            btn.Visible = true
            visibleCount = visibleCount + 1
        else
            btn.Visible = false
        end
    end
    self.container.CanvasSize = UDim2.new(0, 0, 0, visibleCount * 32)
end

return ServerBrowserHandler