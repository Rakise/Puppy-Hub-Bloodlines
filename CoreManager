--[[
    Puppy-Hub CoreManager (Bloodlines Edition)
    Integrates:
    - Custom Server Browser (ReplicatedStorage based)
    - Bloodlines Player ESP (Settings based)
    - Mob/NPC ESP (StringValue based)
    - Item ESP (Trinket/Fruit/Gem)
    - Trans Trail
    - Standard features (AutoAim, etc)
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Base URL
local BRAZIL_HUB_BASE_URL = "https://raw.githubusercontent.com/Rakise/Puppy-Hub-Bloodlines/refs/heads/main/"
local REPO_BASE_URL = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/refs/heads/main/'

local Library = loadstring(game:HttpGet(REPO_BASE_URL .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/SaveManager.lua'))()

local function safeRequire(url, ...)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if success then
        if type(result) == "table" and result.new then
            return result.new(...)
        end
        return result
    else
        warn("[PuppyHub] Failed to load module: " .. url)
        return nil
    end
end

-- Handlers
local ServerBrowserHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ServerBrowserHandler")
local PlayerESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "PlayerESPHandler")
local MobESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "MobESPHandler")
local ItemESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ItemESPHandler")
local ChakraESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ChakraESPHandler")
local TransTrail = safeRequire(BRAZIL_HUB_BASE_URL .. "TransTrail")
local ObserveUI = safeRequire(BRAZIL_HUB_BASE_URL .. "ObserveUI", CoreGui)
local ChatLog = safeRequire(BRAZIL_HUB_BASE_URL .. "ChatLog", CoreGui)
local NoFog = safeRequire(BRAZIL_HUB_BASE_URL .. "NoFog")

-- UI Setup
local Window = Library:CreateWindow({
    Title = '[Puppy Hub] Bloodlines ðŸ©¸',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

local Tabs = {
    Main = Window:AddTab('Main'),
    Visuals = Window:AddTab('Visuals'),
    Servers = Window:AddTab('Server List'),
    Settings = Window:AddTab('UI Settings'),
}

-- ========================================
-- VISUALS TAB
-- ========================================
local PlayerGroup = Tabs.Visuals:AddLeftGroupbox('Player ESP')
local ItemGroup = Tabs.Visuals:AddRightGroupbox('World ESP')
local MiscGroup = Tabs.Visuals:AddLeftGroupbox('Misc')

-- Player
PlayerGroup:AddToggle('PlayerESP', {
    Text = 'Enable Player ESP', Default = false,
    Tooltip = 'Shows players, weapons, and health.',
    Callback = function(val)
        if PlayerESPHandler then
            if val then PlayerESPHandler:enable() else PlayerESPHandler:disable() end
        end
    end
})

-- Observe / Chat
PlayerGroup:AddToggle('ObserveUI', {
    Text = 'Observe UI', Default = false,
    Tooltip = 'Click players in the list to spectate them.',
    Callback = function(val)
        if ObserveUI then
            if val then ObserveUI:enable() else ObserveUI:disable() end
        end
    end
})

PlayerGroup:AddToggle('ChatLogs', {
    Text = 'Chat Logs', Default = false,
    Tooltip = 'Shows a custom chat log.',
    Callback = function(val)
        if ChatLog then
            if val then ChatLog:enable() else ChatLog:disable() end
        end
    end
})

-- Mobs / Items
ItemGroup:AddToggle('MobESP', {
    Text = 'Mob ESP (Combat)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleMobs(val) end end
})

ItemGroup:AddToggle('NpcESP', {
    Text = 'NPC ESP (Dialog)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleNPCs(val) end end
})

ItemGroup:AddDivider()

ItemGroup:AddToggle('TrinketESP', {
    Text = 'Trinket ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Trinket", val) end end
})

ItemGroup:AddToggle('FruitESP', {
    Text = 'Fruit ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Fruit", val) end end
})

ItemGroup:AddToggle('GemESP', {
    Text = 'Gem ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Gem", val) end end
})

ItemGroup:AddToggle('ChakraESP', {
    Text = 'Chakra Point ESP', Default = false,
    Callback = function(val) 
        if ChakraESPHandler then 
            if val then ChakraESPHandler:enable() else ChakraESPHandler:disable() end 
        end 
    end
})

ItemGroup:AddSlider('ESPDistance', {
    Text = 'ESP Distance', Default = 1000, Min = 100, Max = 5000, Rounding = 0,
    Callback = function(val)
        if ItemESPHandler then ItemESPHandler:setMaxDistance(val) end
        if MobESPHandler then MobESPHandler:setMaxDistance(val) end
    end
})

-- Misc
MiscGroup:AddToggle('TransTrailToggle', {
    Text = 'Trans Flag Trail', Default = false,
    Callback = function(val)
        if TransTrail then if val then TransTrail:enable() else TransTrail:disable() end end
    end
})

MiscGroup:AddToggle('NoFogToggle', {
    Text = 'No Fog', Default = false,
    Callback = function(val)
        if NoFog then if val then NoFog:enable() else NoFog:disable() end end
    end
})

-- ========================================
-- SERVER BROWSER TAB
-- ========================================
if ServerBrowserHandler then
    local ServerGroup = Tabs.Servers:AddLeftGroupbox('Server Browser')
    ServerGroup:AddLabel('Game ID: 10266164381')
    
    ServerGroup:AddButton('Refresh Servers', function() ServerBrowserHandler:Refresh() end)
    
    ServerGroup:AddInput('ServerSearch', {
        Default = '', Numeric = false, Finished = false, Text = 'Search Server', Placeholder = 'Name...',
        Callback = function(val) ServerBrowserHandler:Search(val) end
    })

    -- FIX: Use Library-compatible container that expands naturally
    -- We add a Frame to the Container, set AutomaticSize Y, and use UIListLayout
    local listContainer = Instance.new("Frame")
    listContainer.Name = "ServerListContainer"
    listContainer.Size = UDim2.new(1, 0, 0, 0) -- Height starts at 0
    listContainer.AutomaticSize = Enum.AutomaticSize.Y -- Expand based on children
    listContainer.BackgroundTransparency = 1
    
    -- Add to Library Container (LinoriaLib handles the scrolling of the Tab itself)
    listContainer.Parent = ServerGroup.Container 
    
    local layout = Instance.new("UIListLayout")
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 2)
    layout.Parent = listContainer
    
    -- Initialize handler with this container
    ServerBrowserHandler:Initialize(listContainer)
end

-- ========================================
-- UI SETTINGS
-- ========================================
local MenuGroup = Tabs.Settings:AddLeftGroupbox('Menu')
MenuGroup:AddButton('Unload', function() Library:Unload() end)
MenuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { Default = 'Insert', NoUI = true, Text = 'Menu keybind' })
Library.ToggleKeybind = Options.MenuKeybind

ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
ThemeManager:SetFolder('PuppyHub')
SaveManager:SetFolder('PuppyHub/Bloodlines')
ThemeManager:ApplyToTab(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

print("[Puppy Hub] Bloodlines Edition Loaded")