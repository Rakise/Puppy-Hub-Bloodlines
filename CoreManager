-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Constants
local BRAZIL_HUB_BASE_URL = "https://ghproxy.net/https://raw.githubusercontent.com/Rakise/Puppy-Hub-Bloodlines/refs/heads/main/"
local REPO_BASE_URL = 'https://ghproxy.net/https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/refs/heads/main/'
local CONFIG_FILE = "PuppyHub_Bloodlines_Config.json"

-- Load Library
local Library = loadstring(game:HttpGet(REPO_BASE_URL .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/SaveManager.lua'))()

-- Helper: Safe Require
local function safeRequire(url, ...)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if success then
        if type(result) == "table" and result.new then
            return result.new(...)
        end
        return result
    else
        warn("[PuppyHub] Failed to load module: " .. url)
        return nil
    end
end

-- Load Modules
local PlayerESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "PlayerESPHandler")
local MobESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "MobESPHandler")
local ItemESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ItemESPHandler")
local ChakraESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ChakraESPHandler")
local CorruptedESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "CorruptedESPHandler")
local TransTrail = safeRequire(BRAZIL_HUB_BASE_URL .. "TransTrail")
local NoFog = safeRequire(BRAZIL_HUB_BASE_URL .. "NoFog")
local ObserveUI = safeRequire(BRAZIL_HUB_BASE_URL .. "ObserveUI", PlayerGui)
local ChatLog = safeRequire(BRAZIL_HUB_BASE_URL .. "ChatLog", PlayerGui)
local BossFarm = safeRequire(BRAZIL_HUB_BASE_URL .. "BossFarm")
local AutoFarmHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "AutoFarmHandler")

-- ============================================================================
-- GLOBAL STATE
-- ============================================================================

local State = {
    WalkSpeed = 16, WalkSpeedEnabled = false,
    JumpPower = 50, JumpPowerEnabled = false,
    Fly = false, FlySpeed = 50, FallSpeed = 25,
    Noclip = false, NoclipSpeed = 150, NoclipTween = 1,
    CFrameSpeed = false, CFrameSpeedValue = 1,
    PanicModeOption = true, IsPanicMode = false
}

local CoreConnections = {} -- Holds explicit RunService connections

-- ============================================================================
-- MANUAL CONNECTION MANAGEMENT (Loop Controls)
-- ============================================================================

local function StopMovementLoops()
    print("[PuppyHub] Stopping Core Movement Loops...")
    for name, conn in pairs(CoreConnections) do
        if conn and conn.Connected then
            conn:Disconnect()
        end
    end
    CoreConnections = {}
end

local function StartMovementLoops()
    StopMovementLoops() -- Ensure clean start
    
    print("[PuppyHub] Starting Core Movement Loops...")

    -- 1. Heartbeat: Stats (WalkSpeed, JumpPower) & Panic Check
    CoreConnections.Heartbeat = RunService.Heartbeat:Connect(function()
        local char = LocalPlayer.Character
        if not char then return end
        
        -- Panic Check Logic
        if State.PanicModeOption then
            local found = false
            for _, player in ipairs(Players:GetPlayers()) do
                local SETTINGS_FOLDER = ReplicatedStorage:FindFirstChild("Settings")
                if SETTINGS_FOLDER then
                    local pSettings = SETTINGS_FOLDER:FindFirstChild(player.Name)
                    if pSettings then
                        local sVal = pSettings:FindFirstChild("CurrentSkill")
                        if sVal and type(sVal.Value) == "string" and string.find(string.lower(sVal.Value), "sense") then found = true break end
                    end
                end
                if not found and player.Character then
                    for _, tool in ipairs(player.Character:GetChildren()) do
                        if tool:IsA("Tool") and string.find(string.lower(tool.Name), "chakra sense") then found = true break end
                    end
                end
                if found then break end
            end
            State.IsPanicMode = found
        else
            State.IsPanicMode = false
        end

        -- Stats Application
        local hum = char:FindFirstChild("Humanoid")
        if hum and not State.IsPanicMode then
            if State.WalkSpeedEnabled and hum.WalkSpeed ~= State.WalkSpeed then hum.WalkSpeed = State.WalkSpeed end
            if State.JumpPowerEnabled and hum.UseJumpPower and hum.JumpPower ~= State.JumpPower then hum.JumpPower = State.JumpPower end
        end
    end)

    -- 2. RenderStepped: Fly & CFrame Speed
    CoreConnections.RenderStepped = RunService.RenderStepped:Connect(function()
        if State.IsPanicMode then return end
        
        local char = LocalPlayer.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if not root or not char:FindFirstChild("Humanoid") then return end
        
        -- Fly Logic
        if State.Fly then
            local cam = Workspace.CurrentCamera
            local velocity = Vector3.new()
            local lookVector = (cam.Focus.p - cam.CFrame.p).Unit
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then velocity = velocity + Vector3.new(0, State.FlySpeed, 0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then velocity = velocity + lookVector * State.FlySpeed end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then velocity = velocity - lookVector * State.FlySpeed end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then velocity = velocity - Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then velocity = velocity + Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed end
            
            velocity = velocity - Vector3.new(0, State.FallSpeed, 0)
            root.Velocity = velocity
        end
        
        -- CFrame Speed Logic
        if State.CFrameSpeed then
            local moveDir = char.Humanoid.MoveDirection
            local moveVec = moveDir * (State.CFrameSpeedValue / 10) 
            root.CFrame = root.CFrame + moveVec
            root.Velocity = Vector3.new(0, root.Velocity.Y, 0)
        end
    end)

    -- 3. Stepped: Noclip (Physics)
    CoreConnections.Noclip = RunService.Stepped:Connect(function()
        local char = LocalPlayer.Character
        if State.Noclip and char and not State.IsPanicMode then
            local hum = char:FindFirstChild("Humanoid")
            local root = char:FindFirstChild("HumanoidRootPart")
            if hum and root then
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                for _, v in ipairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
                local newpos = root.CFrame + hum.MoveDirection * State.NoclipTween
                TweenService:Create(root, TweenInfo.new(0, Enum.EasingStyle.Linear), {CFrame = newpos}):Play()
            end
        else
            -- Optional: Restore collision if needed, but Roblox handles this mostly on respawn/disable
            if char then
               local root = char:FindFirstChild("HumanoidRootPart")
               if root then root.CanCollide = true end
            end
        end
    end)
end

-- ============================================================================
-- PERSISTENCE & CONFIG
-- ============================================================================

local Config = { AutoSummon = false, AutoPickup = false }

local function SaveConfig()
    if writefile then
        local json = HttpService:JSONEncode(Config)
        writefile(CONFIG_FILE, json)
    end
end

local function LoadConfig()
    if isfile and isfile(CONFIG_FILE) then
        local content = readfile(CONFIG_FILE)
        local success, decoded = pcall(HttpService.JSONDecode, HttpService, content)
        if success and decoded then
            Config.AutoSummon = decoded.AutoSummon
            Config.AutoPickup = decoded.AutoPickup
        end
    end
end

-- ============================================================================
-- AUTO LOGIN & FORCEFIELD LOGIC
-- ============================================================================

local function RemoveForcefield()
    print("[PuppyHub] Removing Forcefield Sequence Initiated...")
    
    -- 1. CRITICAL: Stop AutoFarm Threads/Connections Manually
    if AutoFarmHandler and AutoFarmHandler.emergencyStop then
        AutoFarmHandler.emergencyStop()
    end

    -- 2. CRITICAL: Stop Movement/Core Loops Manually
    StopMovementLoops()

    -- 3. Execute TP (20 Studs + 0.3s Delay)
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if root then
        local forwardPos = root.CFrame * CFrame.new(0, 0, -20)
        local originalPos = root.CFrame
        local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

        -- Tween Out
        local tweenForward = TweenService:Create(root, tweenInfo, {CFrame = forwardPos})
        tweenForward:Play()
        tweenForward.Completed:Wait()
        
        -- Wait 0.3s
        task.wait(0.3)
        
        -- Tween Back
        local tweenBack = TweenService:Create(root, tweenInfo, {CFrame = originalPos})
        tweenBack:Play()
        tweenBack.Completed:Wait()
        print("[PuppyHub] Forcefield removed. Resume operations.")
    end

    -- 4. Restart Loops (Safe now)
    StartMovementLoops()
end

local function AutoLoginRoutine()
    print("[PuppyHub] Starting Auto-Login Routine...")
    local clientGui = PlayerGui:WaitForChild("ClientGui", 30)
    if not clientGui then return end
    
    local menuScreen = clientGui:WaitForChild("MenuScreen", 10)
    if menuScreen then
        local loadingScreen = menuScreen:WaitForChild("LoadingScreen", 10)
        if loadingScreen then
            repeat task.wait(0.5) until loadingScreen.BackgroundTransparency >= 0.9 or not loadingScreen.Visible
        end
        local menuFrame = menuScreen:WaitForChild("Menu", 5)
        if menuFrame then
            local continueBtn = menuFrame:FindFirstChild("Continue")
            if continueBtn and continueBtn:IsA("ImageButton") then
                task.wait(1)
                if firesignal then
                    firesignal(continueBtn.MouseButton1Down)
                    task.wait(0.1)
                    firesignal(continueBtn.MouseButton1Up)
                    task.wait(0.1)
                    firesignal(continueBtn.MouseButton1Click)
                else
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,1)
                    task.wait(0.1)
                    VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,1)
                end
            end
        end
    end
    
    task.wait(7)
    
    if AutoFarmHandler and AutoFarmHandler.checkSafety then
        local safe, reason = AutoFarmHandler.checkSafety()
        if not safe then
            print("[PuppyHub] âš ï¸ Unsafe: " .. tostring(reason) .. ". Hopping...")
            if AutoFarmHandler.executeServerHop then AutoFarmHandler.executeServerHop() return end
        end
    end
    
    RemoveForcefield()
    
    if Config.AutoSummon and AutoFarmHandler then
        print("[PuppyHub] Resuming Auto Farm...")
        if Config.AutoPickup then AutoFarmHandler.Settings.AutoPickup = true end
        AutoFarmHandler.toggleSummon(true)
    end
end

LoadConfig()
if Config.AutoSummon then task.spawn(AutoLoginRoutine) end

-- ============================================================================
-- UI SETUP & TAB GROUPS
-- ============================================================================

local Window = Library:CreateWindow({
    Title = '[Puppy Hub] Bloodlines ðŸ©¸',
    Center = true, AutoShow = true, TabPadding = 8, MenuFadeTime = 0.2,
    Size = UDim2.fromOffset(700, 600)
})

local Tabs = {
    Visuals = Window:AddTab('Visuals'),
    Movement = Window:AddTab('Movement'),
    Farming = Window:AddTab('Farming'),
    Servers = Window:AddTab('Server List'),
    Settings = Window:AddTab('UI Settings'),
}

local MoveGroup = Tabs.Movement:AddLeftGroupbox('Character')
local FlyGroup = Tabs.Movement:AddRightGroupbox('Fly')
local NoclipGroup = Tabs.Movement:AddLeftGroupbox('Noclip')
local CFrameGroup = Tabs.Movement:AddRightGroupbox('CFrame Speed')

MoveGroup:AddToggle('WalkSpeedToggle', { Text = 'Enable WalkSpeed', Default = false, Callback = function(val) State.WalkSpeedEnabled = val end })
MoveGroup:AddSlider('WalkSpeedSlider', { Text = 'Speed', Default = 16, Min = 16, Max = 45, Rounding = 0, Callback = function(val) State.WalkSpeed = val end })
MoveGroup:AddToggle('PanicModeToggle', { Text = 'Auto Panic (Chakra Sense)', Default = true, Callback = function(val) State.PanicModeOption = val end })
MoveGroup:AddToggle('JumpPowerToggle', { Text = 'Enable JumpPower', Default = false, Callback = function(val) State.JumpPowerEnabled = val end })
MoveGroup:AddSlider('JumpPowerSlider', { Text = 'Power', Default = 50, Min = 0, Max = 100, Rounding = 0, Callback = function(val) State.JumpPower = val end })

FlyGroup:AddToggle('FlyToggle', { Text = 'Enable Fly', Default = false, Callback = function(val) State.Fly = val end }):AddKeyPicker('FlyKey', { Default = 'F2', NoUI = true, Text = 'Fly Bind' })
FlyGroup:AddSlider('FlySpeed', { Text = 'Fly Speed', Default = 50, Min = 10, Max = 250, Rounding = 0, Callback = function(val) State.FlySpeed = val end })
FlyGroup:AddSlider('FallSpeed', { Text = 'Fall Speed', Default = 25, Min = 0, Max = 100, Rounding = 0, Callback = function(val) State.FallSpeed = val end })
Options.FlyKey:OnClick(function() Toggles.FlyToggle:SetValue(not Toggles.FlyToggle.Value) end)

NoclipGroup:AddToggle('NoclipToggle', { Text = 'Enable Noclip', Default = false, Callback = function(val) State.Noclip = val end }):AddKeyPicker('NoclipKey', { Default = 'F3', NoUI = true, Text = 'Noclip Bind' })
NoclipGroup:AddSlider('NoclipSpeed', { Text = 'Move Speed', Default = 150, Min = 100, Max = 275, Rounding = 0, Callback = function(val) State.NoclipSpeed = val end })
NoclipGroup:AddSlider('TweenSpeed', { Text = 'Tween Speed', Default = 1, Min = 0, Max = 5, Rounding = 1, Callback = function(val) State.NoclipTween = val end })
Options.NoclipKey:OnClick(function() Toggles.NoclipToggle:SetValue(not Toggles.NoclipToggle.Value) end)

CFrameGroup:AddToggle('CFrameToggle', { Text = 'Enable CFrame Speed', Default = false, Callback = function(val) State.CFrameSpeed = val end }):AddKeyPicker('CFrameKey', { Default = 'F4', NoUI = true, Text = 'CF Speed Bind' })
CFrameGroup:AddSlider('CFrameSpeed', { Text = 'Speed Factor', Default = 1, Min = 1, Max = 250, Rounding = 0, Callback = function(val) State.CFrameSpeedValue = val end })
Options.CFrameKey:OnClick(function() Toggles.CFrameToggle:SetValue(not Toggles.CFrameToggle.Value) end)

if BossFarm and AutoFarmHandler then
    local FarmLeft = Tabs.Farming:AddLeftGroupbox('Auto Summon & Pickup')
    local FarmRight = Tabs.Farming:AddRightGroupbox('Boss Farm')

    FarmLeft:AddToggle('AutoPickupToggle', { Text = 'Auto Pickup Items', Default = Config.AutoPickup, Callback = function(val) Config.AutoPickup = val SaveConfig() AutoFarmHandler.togglePickup(val) end })
    FarmLeft:AddToggle('AutoSummonToggle', { Text = 'Auto Fruit Summoning', Default = Config.AutoSummon, Callback = function(val) Config.AutoSummon = val SaveConfig() AutoFarmHandler.toggleSummon(val) end }):AddKeyPicker('AutoSummonKey', { Default = 'P', Text = 'Toggle Summon', Mode = 'Toggle' })
    Options.AutoSummonKey:OnClick(function() Toggles.AutoSummonToggle:SetValue(not Toggles.AutoSummonToggle.Value) end)
    FarmLeft:AddSlider('PickupRange', { Text = 'Pickup Range', Default = 50, Min = 10, Max = 100, Rounding = 0, Callback = function(val) AutoFarmHandler.Settings.PickupRange = val end })

    FarmRight:AddToggle('BossFarmEnabled', { Text = 'Enable Boss Farm', Default = false, Callback = function(val) BossFarm.Settings.Enabled = val if val then BossFarm.start() else BossFarm.stop() end end })
    FarmRight:AddDropdown('BossSelection', { Values = BossFarm.bossDatabase, Default = 1, Multi = true, Text = 'Select Bosses', Callback = function(val) BossFarm.Settings.SelectedBosses = val end })
    FarmRight:AddToggle('ServerHopBoss', { Text = 'Hop If No Boss', Default = false, Callback = function(val) BossFarm.Settings.ServerHopIfNoBoss = val end })
    FarmRight:AddToggle('ServerHopChakra', { Text = 'Hop On Chakra Sense', Default = false, Callback = function(val) BossFarm.Settings.ServerHopIfChakraSense = val end })
end

-- ============================================================================
-- VISUALS
-- ============================================================================
local PlayerGroup = Tabs.Visuals:AddLeftGroupbox('Player ESP')
local ItemGroup = Tabs.Visuals:AddRightGroupbox('World ESP')
local MiscGroup = Tabs.Visuals:AddLeftGroupbox('Misc')

PlayerGroup:AddToggle('PlayerESP', { Text = 'Enable Player ESP', Default = false, Callback = function(val) if PlayerESPHandler then if val then PlayerESPHandler:enable() else PlayerESPHandler:disable() end end end })
PlayerGroup:AddToggle('ObserveUI', { Text = 'Observe UI', Default = false, Callback = function(val) if ObserveUI then if val then ObserveUI:enable() else ObserveUI:disable() end end end })
PlayerGroup:AddToggle('ChatLogs', { Text = 'Chat Logs', Default = false, Callback = function(val) if ChatLog then if val then ChatLog:enable() else ChatLog:disable() end end end })

ItemGroup:AddToggle('MobESP', { Text = 'Mob ESP (Combat)', Default = false, Callback = function(val) if MobESPHandler then MobESPHandler:toggleMobs(val) end end })
ItemGroup:AddToggle('NpcESP', { Text = 'NPC ESP (Dialog)', Default = false, Callback = function(val) if MobESPHandler then MobESPHandler:toggleNPCs(val) end end })
ItemGroup:AddDivider()
ItemGroup:AddToggle('TrinketESP', { Text = 'Trinket ESP', Default = false, Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Trinket", val) end end })
ItemGroup:AddToggle('FruitESP', { Text = 'Fruit ESP', Default = false, Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Fruit", val) end end })
ItemGroup:AddToggle('GemESP', { Text = 'Gem ESP', Default = false, Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Gem", val) end end })
ItemGroup:AddToggle('ChakraESP', { Text = 'Chakra Point ESP', Default = false, Callback = function(val) if ChakraESPHandler then if val then ChakraESPHandler:enable() else ChakraESPHandler:disable() end end end })
ItemGroup:AddToggle('CorruptedESP', { Text = 'Corrupted Point ESP', Default = false, Callback = function(val) if CorruptedESPHandler then if val then CorruptedESPHandler:enable() else CorruptedESPHandler:disable() end end end })

MiscGroup:AddToggle('TransTrailToggle', { Text = 'Trans Flag Trail', Default = false, Callback = function(val) if TransTrail then if val then TransTrail:enable() else TransTrail:disable() end end end })
MiscGroup:AddToggle('NoFogToggle', { Text = 'No Fog', Default = false, Callback = function(val) if NoFog then if val then NoFog:enable() else NoFog:disable() end end end })

-- ============================================================================
-- SERVER BROWSER
-- ============================================================================
local ServerGroup = Tabs.Servers:AddLeftGroupbox('Server Browser (API)')
local function joinServer(id)
    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if dataEvent then dataEvent:FireServer("ServerTeleport", id, 14) end
end
local StatusLabel = ServerGroup:AddLabel("Click 'Refresh' to load servers.")
local serverScroll = Library:Create('ScrollingFrame', { Name = "ServerListScroll", Size = UDim2.new(1, -4, 0, 400), ZIndex = 6, Parent = ServerGroup.Container, BackgroundColor3 = Library.BackgroundColor, BorderColor3 = Library.OutlineColor, BorderMode = Enum.BorderMode.Inset, ScrollBarThickness = 6, ScrollBarImageColor3 = Library.AccentColor })
Library:Create('UIListLayout', { Padding = UDim.new(0, 5), FillDirection = Enum.FillDirection.Vertical, SortOrder = Enum.SortOrder.LayoutOrder, HorizontalAlignment = Enum.HorizontalAlignment.Center, Parent = serverScroll })

local function fetchServers()
    for _, child in ipairs(serverScroll:GetChildren()) do if child:IsA("TextButton") then child:Destroy() end end
    task.spawn(function()
        local allServers = {}
        local cursor = ""
        local pageNum = 1
        local continueFetching = true
        while continueFetching do
            StatusLabel:SetText("Fetching Page " .. pageNum .. "...")
            local success, response = pcall(function()
                local url = string.format("https://roproxy-production-0200.up.railway.app/games/v1/games/%d/servers/0?sortOrder=2&excludeFullGames=false&limit=100", GAME_ID)
                if cursor ~= "" then url = url .. "&cursor=" .. cursor end
                return game:HttpGet(url)
            end)
            if not success or not response then StatusLabel:SetText("Failed to fetch page " .. pageNum) break end
            local jsonSuccess, data = pcall(HttpService.JSONDecode, HttpService, response)
            if not jsonSuccess or not data or not data.data then break end
            for _, s in ipairs(data.data) do table.insert(allServers, s) end
            if data.nextPageCursor and data.nextPageCursor ~= "" then cursor = data.nextPageCursor pageNum = pageNum + 1 task.wait(0.1) else continueFetching = false end
        end
        if #allServers > 0 then
            StatusLabel:SetText("Sorting " .. #allServers .. " servers...")
            table.sort(allServers, function(a, b) return (a.playing or 0) > (b.playing or 0) end)
            StatusLabel:SetText(string.format("Loaded %d servers.", #allServers))
            for _, server in ipairs(allServers) do
                local text = string.format("%d/%d Plrs | FPS: %.0f | Ping: %d", server.playing, server.maxPlayers, server.fps or 0, server.ping or 0)
                local btn = Library:Create('TextButton', { Parent = serverScroll, Text = text, Size = UDim2.new(1, -10, 0, 30), BackgroundColor3 = Library.MainColor, TextColor3 = Library.FontColor, Font = Library.Font, TextSize = 14, ZIndex = 10 })
                Library:OnHighlight(btn, btn, { BorderColor3 = 'AccentColor' }, { BorderColor3 = 'OutlineColor' })
                btn.MouseButton1Click:Connect(function() joinServer(server.id) end)
            end
            local layout = serverScroll:FindFirstChildOfClass("UIListLayout")
            if layout then serverScroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y) end
        else StatusLabel:SetText("No servers found.") end
    end)
end
ServerGroup:AddButton('Refresh Servers', fetchServers)

-- ============================================================================
-- INIT
-- ============================================================================
local MenuGroup = Tabs.Settings:AddLeftGroupbox('Menu')
MenuGroup:AddButton('Unload', function() StopMovementLoops() Library:Unload() end)
MenuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { Default = 'Insert', NoUI = true, Text = 'Menu keybind' })
Library.ToggleKeybind = Options.MenuKeybind
ThemeManager:SetLibrary(Library) SaveManager:SetLibrary(Library) ThemeManager:SetFolder('PuppyHub') SaveManager:SetFolder('PuppyHub/Bloodlines') ThemeManager:ApplyToTab(Tabs.Settings) SaveManager:BuildConfigSection(Tabs.Settings)

-- Initialize Loops
StartMovementLoops()

print("[Puppy Hub] Bloodlines Edition Loaded")