-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Base URLs
local BRAZIL_HUB_BASE_URL = "https://raw.githubusercontent.com/Rakise/Puppy-Hub-Bloodlines/refs/heads/main/"
local REPO_BASE_URL = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/refs/heads/main/'

-- Load Library
local Library = loadstring(game:HttpGet(REPO_BASE_URL .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/SaveManager.lua'))()

-- Helper: Safe Require
local function safeRequire(url, ...)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if success then
        if type(result) == "table" and result.new then
            return result.new(...)
        end
        return result
    else
        warn("[PuppyHub] Failed to load module: " .. url)
        return nil
    end
end

-- Load Modules
local PlayerESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "PlayerESPHandler")
local MobESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "MobESPHandler")
local ItemESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ItemESPHandler")
local ChakraESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ChakraESPHandler")
local TransTrail = safeRequire(BRAZIL_HUB_BASE_URL .. "TransTrail")
local NoFog = safeRequire(BRAZIL_HUB_BASE_URL .. "NoFog")
local ObserveUI = safeRequire(BRAZIL_HUB_BASE_URL .. "ObserveUI", PlayerGui)
local ChatLog = safeRequire(BRAZIL_HUB_BASE_URL .. "ChatLog", PlayerGui)

-- ============================================================================
-- GLOBAL STATE & CONFIG
-- ============================================================================

local State = {
    -- Movement
    WalkSpeed = 16,
    WalkSpeedEnabled = false,
    JumpPower = 50,
    JumpPowerEnabled = false,
    
    -- Fly
    Fly = false,
    FlySpeed = 50,
    FallSpeed = 25,
    
    -- Noclip
    Noclip = false,
    NoclipSpeed = 150,
    NoclipTween = 1,
    
    -- CFrame Speed
    CFrameSpeed = false,
    CFrameSpeedValue = 1,
    
    -- Internal
    IsPanicMode = false -- True if Chakra Sense is active on ANY player
}

local SETTINGS_FOLDER = ReplicatedStorage:WaitForChild("Settings", 10)

-- ============================================================================
-- UI SETUP
-- ============================================================================

local Window = Library:CreateWindow({
    Title = '[Puppy Hub] Bloodlines ðŸ©¸',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2,
    Size = UDim2.fromOffset(700, 600) -- Increased width
})

local Tabs = {
    Visuals = Window:AddTab('Visuals'),
    Movement = Window:AddTab('Movement'),
    Servers = Window:AddTab('Server List'),
    Settings = Window:AddTab('UI Settings'),
}

-- ============================================================================
-- MOVEMENT LOGIC (PANIC MODE ENABLED)
-- ============================================================================

-- 1. Panic Check (Chakra Sense - Global Check)
local function checkPanicMode()
    local found = false
    
    -- Iterate through ALL players, not just LocalPlayer
    for _, player in ipairs(Players:GetPlayers()) do
        -- Check ReplicatedStorage Settings (Primary Check)
        if SETTINGS_FOLDER then
            local playerSettings = SETTINGS_FOLDER:FindFirstChild(player.Name)
            if playerSettings then
                local sVal = playerSettings:FindFirstChild("CurrentSkill")
                if sVal and type(sVal.Value) == "string" then
                    if string.find(string.lower(sVal.Value), "sense") then
                        found = true
                        break -- Stop checking if we found one
                    end
                end
            end
        end
        
        -- Fallback: Check Character Tools (Secondary Check)
        if not found and player.Character then
            for _, child in ipairs(player.Character:GetChildren()) do
                if child:IsA("Tool") and string.find(string.lower(child.Name), "chakra sense") then
                    found = true
                    break
                end
            end
        end
        
        if found then break end
    end
    
    State.IsPanicMode = found
end

-- 2. WalkSpeed & JumpPower Loop
RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    
    -- Update Panic State
    checkPanicMode()
    
    if hum then
        -- WalkSpeed Logic
        -- Only apply if enabled AND NOT in panic mode
        if State.WalkSpeedEnabled and not State.IsPanicMode then
            if hum.WalkSpeed ~= State.WalkSpeed then
                hum.WalkSpeed = State.WalkSpeed
            end
        end
        -- If disabled or panic, do NOTHING (let game control speed)
        
        -- JumpPower Logic
        if State.JumpPowerEnabled and not State.IsPanicMode then
            if hum.UseJumpPower then
                if hum.JumpPower ~= State.JumpPower then
                    hum.JumpPower = State.JumpPower
                end
            else
                -- Convert power to height roughly if needed, though UseJumpPower is standard
                -- hum.JumpHeight = State.JumpPower / 5 
            end
        end
    end
end)

-- 3. Fly Logic
RunService.RenderStepped:Connect(function()
    -- Panic Mode disables Fly instantly
    if not State.Fly or State.IsPanicMode then return end
    
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local cam = Workspace.CurrentCamera
    local velocity = Vector3.new()
    local lookVector = (cam.Focus.p - cam.CFrame.p).Unit
    
    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
        velocity = velocity + Vector3.new(0, State.FlySpeed, 0)
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then
        velocity = velocity + lookVector * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then
        velocity = velocity - lookVector * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then
        velocity = velocity - Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then
        velocity = velocity + Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed
    end
    
    velocity = velocity - Vector3.new(0, State.FallSpeed, 0)
    root.Velocity = velocity
end)

-- 4. Noclip Logic
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        -- Panic Mode disables Noclip instantly
        if State.Noclip and char and not State.IsPanicMode then
            local hum = char:FindFirstChild("Humanoid")
            local root = char:FindFirstChild("HumanoidRootPart")
            
            if hum and root then
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                
                for _, v in ipairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
                
                local newpos = root.CFrame + hum.MoveDirection * State.NoclipTween
                TweenService:Create(root, TweenInfo.new(0, Enum.EasingStyle.Linear), {CFrame = newpos}):Play()
            end
        else
            -- Restore collision if Noclip off OR Panic Mode on
            if char then
                local root = char:FindFirstChild("HumanoidRootPart")
                if root then root.CanCollide = true end
            end
        end
        task.wait()
    end
end)

-- 5. CFrame Speed Logic
RunService.RenderStepped:Connect(function()
    -- Panic Mode disables CFrame Speed instantly
    if State.CFrameSpeed and not State.IsPanicMode then
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
            local moveDir = char.Humanoid.MoveDirection
            local moveVec = moveDir * (State.CFrameSpeedValue / 10) 
            char.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame + moveVec
            char.HumanoidRootPart.Velocity = Vector3.new(0, char.HumanoidRootPart.Velocity.Y, 0)
        end
    end
end)


-- ============================================================================
-- MOVEMENT TAB UI
-- ============================================================================
local MoveGroup = Tabs.Movement:AddLeftGroupbox('Character')
local FlyGroup = Tabs.Movement:AddRightGroupbox('Fly')
local NoclipGroup = Tabs.Movement:AddLeftGroupbox('Noclip')
local CFrameGroup = Tabs.Movement:AddRightGroupbox('CFrame Speed')

-- Walkspeed
MoveGroup:AddToggle('WalkSpeedToggle', {
    Text = 'Enable WalkSpeed',
    Default = false,
    Callback = function(val) State.WalkSpeedEnabled = val end
})
MoveGroup:AddSlider('WalkSpeedSlider', {
    Text = 'Speed', Default = 16, Min = 16, Max = 45, Rounding = 0,
    Callback = function(val) State.WalkSpeed = val end
})

-- JumpPower
MoveGroup:AddToggle('JumpPowerToggle', {
    Text = 'Enable JumpPower',
    Default = false,
    Callback = function(val) State.JumpPowerEnabled = val end
})
MoveGroup:AddSlider('JumpPowerSlider', {
    Text = 'Power', Default = 50, Min = 0, Max = 100, Rounding = 0, -- Changed Min to 0 to allow grabbing from char
    Callback = function(val) State.JumpPower = val end
})

-- Fly
FlyGroup:AddToggle('FlyToggle', {
    Text = 'Enable Fly', Default = false,
    Callback = function(val) State.Fly = val end
}):AddKeyPicker('FlyKey', { Default = 'F2', NoUI = true, Text = 'Fly Bind' })

FlyGroup:AddSlider('FlySpeed', {
    Text = 'Fly Speed', Default = 50, Min = 10, Max = 250, Rounding = 0,
    Callback = function(val) State.FlySpeed = val end
})
FlyGroup:AddSlider('FallSpeed', {
    Text = 'Fall Speed', Default = 25, Min = 0, Max = 100, Rounding = 0,
    Callback = function(val) State.FallSpeed = val end
})

Library.ToggleKeybind = Options.MenuKeybind 

Options.FlyKey:OnClick(function()
    Toggles.FlyToggle:SetValue(not Toggles.FlyToggle.Value)
end)

-- Noclip
NoclipGroup:AddToggle('NoclipToggle', {
    Text = 'Enable Noclip', Default = false,
    Callback = function(val) State.Noclip = val end
}):AddKeyPicker('NoclipKey', { Default = 'F3', NoUI = true, Text = 'Noclip Bind' })

Options.NoclipKey:OnClick(function()
    Toggles.NoclipToggle:SetValue(not Toggles.NoclipToggle.Value)
end)

NoclipGroup:AddSlider('NoclipSpeed', {
    Text = 'Move Speed', Default = 150, Min = 100, Max = 275, Rounding = 0,
    Callback = function(val) State.NoclipSpeed = val end
})
NoclipGroup:AddSlider('TweenSpeed', {
    Text = 'Tween Speed', Default = 1, Min = 0, Max = 5, Rounding = 1,
    Callback = function(val) State.NoclipTween = val end
})

-- CFrame Speed
CFrameGroup:AddToggle('CFrameToggle', {
    Text = 'Enable CFrame Speed', Default = false,
    Callback = function(val) State.CFrameSpeed = val end
}):AddKeyPicker('CFrameKey', { Default = 'F4', NoUI = true, Text = 'CF Speed Bind' })

Options.CFrameKey:OnClick(function()
    Toggles.CFrameToggle:SetValue(not Toggles.CFrameToggle.Value)
end)

CFrameGroup:AddSlider('CFrameSpeed', {
    Text = 'Speed Factor', Default = 1, Min = 1, Max = 250, Rounding = 0,
    Callback = function(val) State.CFrameSpeedValue = val end
})


-- ============================================================================
-- VISUALS TAB
-- ============================================================================
local PlayerGroup = Tabs.Visuals:AddLeftGroupbox('Player ESP')
local ItemGroup = Tabs.Visuals:AddRightGroupbox('World ESP')
local MiscGroup = Tabs.Visuals:AddLeftGroupbox('Misc')

PlayerGroup:AddToggle('PlayerESP', {
    Text = 'Enable Player ESP', Default = false,
    Tooltip = 'Shows players, weapons, and health.',
    Callback = function(val)
        if PlayerESPHandler then
            if val then PlayerESPHandler:enable() else PlayerESPHandler:disable() end
        end
    end
})

PlayerGroup:AddToggle('ObserveUI', {
    Text = 'Observe UI', Default = false,
    Callback = function(val)
        if ObserveUI then if val then ObserveUI:enable() else ObserveUI:disable() end end
    end
})

PlayerGroup:AddToggle('ChatLogs', {
    Text = 'Chat Logs', Default = false,
    Callback = function(val)
        if ChatLog then if val then ChatLog:enable() else ChatLog:disable() end end
    end
})

ItemGroup:AddToggle('MobESP', {
    Text = 'Mob ESP (Combat)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleMobs(val) end end
})
ItemGroup:AddToggle('NpcESP', {
    Text = 'NPC ESP (Dialog)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleNPCs(val) end end
})
ItemGroup:AddDivider()
ItemGroup:AddToggle('TrinketESP', {
    Text = 'Trinket ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Trinket", val) end end
})
ItemGroup:AddToggle('FruitESP', {
    Text = 'Fruit ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Fruit", val) end end
})
ItemGroup:AddToggle('GemESP', {
    Text = 'Gem ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Gem", val) end end
})
ItemGroup:AddToggle('ChakraESP', {
    Text = 'Chakra Point ESP', Default = false,
    Callback = function(val) if ChakraESPHandler then if val then ChakraESPHandler:enable() else ChakraESPHandler:disable() end end end
})
ItemGroup:AddSlider('ESPDistance', {
    Text = 'ESP Distance', Default = 1000, Min = 100, Max = 5000, Rounding = 0,
    Callback = function(val)
        if ItemESPHandler then ItemESPHandler:setMaxDistance(val) end
        if MobESPHandler then MobESPHandler:setMaxDistance(val) end
    end
})

MiscGroup:AddToggle('TransTrailToggle', {
    Text = 'Trans Flag Trail', Default = false,
    Callback = function(val) if TransTrail then if val then TransTrail:enable() else TransTrail:disable() end end end
})
MiscGroup:AddToggle('NoFogToggle', {
    Text = 'No Fog', Default = false,
    Callback = function(val) if NoFog then if val then NoFog:enable() else NoFog:disable() end end end
})


-- ============================================================================
-- API SERVER BROWSER (Replaces old ReplicatedStorage browser)
-- ============================================================================
local ServerGroup = Tabs.Servers:AddLeftGroupbox('Server Browser (API)')
local GAME_ID = 10266164381 -- Bloodlines Place ID

-- Bloodlines specific join logic
local function joinServer(id)
    -- 'id' here corresponds to the JobId from the API
    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if dataEvent then
        print("[PuppyHub] Teleporting to server:", id)
        dataEvent:FireServer("ServerTeleport", id, 14)
    else
        warn("[PuppyHub] Could not find DataEvent for teleport!")
    end
end

-- UI Elements for Status
local StatusLabel = ServerGroup:AddLabel("Click 'Refresh' to load servers.")

-- Create a Scrollbox (manually managed for button clearing)
local serverScroll = Library:Create('ScrollingFrame', {
    Name = "ServerListScroll",
    Size = UDim2.new(1, -4, 0, 400),
    ZIndex = 6,
    Parent = ServerGroup.Container,
    BackgroundColor3 = Library.BackgroundColor,
    BorderColor3 = Library.OutlineColor,
    BorderMode = Enum.BorderMode.Inset,
    ScrollBarThickness = 6,
    ScrollBarImageColor3 = Library.AccentColor,
})

Library:Create('UIListLayout', {
    Padding = UDim.new(0, 5),
    FillDirection = Enum.FillDirection.Vertical,
    SortOrder = Enum.SortOrder.LayoutOrder,
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    Parent = serverScroll,
})

local isFetching = false

local function fetchServers()
    if isFetching then return end
    isFetching = true
    StatusLabel:SetText("Fetching via API...")
    
    -- Clear existing buttons in the scroll frame
    for _, child in ipairs(serverScroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    
    task.spawn(function()
        local success, response = pcall(function()
            -- HTTP Get Wrapper
            local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
            local url = string.format(
                "https://roproxy-production-0200.up.railway.app/games/v1/games/%d/servers/0?sortOrder=2&excludeFullGames=false&limit=100",
                GAME_ID
            )
            
            if requestFunc then
                local res = requestFunc({Url = url, Method = "GET"})
                return res.Body
            else
                return game:HttpGet(url)
            end
        end)
        
        isFetching = false
        
        if not success or not response then
            StatusLabel:SetText("Failed to fetch servers.")
            return
        end
        
        local jsonSuccess, data = pcall(HttpService.JSONDecode, HttpService, response)
        if not jsonSuccess or not data or not data.data then
            StatusLabel:SetText("Failed to parse API data.")
            return
        end
        
        local servers = data.data
        
        -- Sort servers by player count (descending)
        table.sort(servers, function(a, b)
            return a.playing > b.playing
        end)
        
        StatusLabel:SetText(string.format("Loaded %d servers.", #servers))
        
        for _, server in ipairs(servers) do
            local text = string.format(
                "%d/%d Plrs | FPS: %.0f | Ping: %d",
                server.playing,
                server.maxPlayers,
                server.fps or 0,
                server.ping or 0
            )
            
            -- Create Button inside ScrollingFrame
            local btn = Library:Create('TextButton', {
                Parent = serverScroll,
                Text = text,
                Size = UDim2.new(1, -10, 0, 30),
                BackgroundColor3 = Library.MainColor,
                TextColor3 = Library.FontColor,
                Font = Library.Font,
                TextSize = 14,
                ZIndex = 10
            })
            
            -- Styling
            Library:OnHighlight(btn, btn,
                { BorderColor3 = 'AccentColor' },
                { BorderColor3 = 'OutlineColor' }
            )
            
            btn.MouseButton1Click:Connect(function() 
                joinServer(server.id) -- server.id is the JobId
            end)
        end
        
        -- Update Canvas Size
        task.wait(0.1)
        local layout = serverScroll:FindFirstChildOfClass("UIListLayout")
        if layout then
            serverScroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        end
    end)
end

ServerGroup:AddButton('Refresh Servers', fetchServers)

-- Initial Fetch
task.delay(1, fetchServers)


-- ============================================================================
-- UI SETTINGS & INIT
-- ============================================================================
local MenuGroup = Tabs.Settings:AddLeftGroupbox('Menu')
MenuGroup:AddButton('Unload', function() Library:Unload() end)
MenuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { Default = 'Insert', NoUI = true, Text = 'Menu keybind' })
Library.ToggleKeybind = Options.MenuKeybind

ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
ThemeManager:SetFolder('PuppyHub')
SaveManager:SetFolder('PuppyHub/Bloodlines')
ThemeManager:ApplyToTab(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

print("[Puppy Hub] Bloodlines Edition Loaded")