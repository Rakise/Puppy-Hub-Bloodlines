-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Base URLs
local BRAZIL_HUB_BASE_URL = "https://ghproxy.net/https://raw.githubusercontent.com/Rakise/Puppy-Hub-Bloodlines/refs/heads/main/"
local REPO_BASE_URL = 'https://ghproxy.net/https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/refs/heads/main/'

-- Load Library
local Library = loadstring(game:HttpGet(REPO_BASE_URL .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/SaveManager.lua'))()

-- Helper: Safe Require
local function safeRequire(url, ...)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if success then
        if type(result) == "table" and result.new then
            return result.new(...)
        end
        return result
    else
        warn("[PuppyHub] Failed to load module: " .. url)
        return nil
    end
end

-- Load Modules
local PlayerESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "PlayerESPHandler")
local MobESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "MobESPHandler")
local ItemESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ItemESPHandler")
local ChakraESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "ChakraESPHandler")
local CorruptedESPHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "CorruptedESPHandler")
local TransTrail = safeRequire(BRAZIL_HUB_BASE_URL .. "TransTrail")
local NoFog = safeRequire(BRAZIL_HUB_BASE_URL .. "NoFog")
local ObserveUI = safeRequire(BRAZIL_HUB_BASE_URL .. "ObserveUI", PlayerGui)
local ChatLog = safeRequire(BRAZIL_HUB_BASE_URL .. "ChatLog", PlayerGui)

-- NEW: Load Farming Modules
local BossFarm = safeRequire(BRAZIL_HUB_BASE_URL .. "BossFarm")
local AutoFarmHandler = safeRequire(BRAZIL_HUB_BASE_URL .. "AutoFarmHandler")

-- ============================================================================
-- GLOBAL STATE & CONFIG
-- ============================================================================

local State = {
    -- Movement
    WalkSpeed = 16,
    WalkSpeedEnabled = false,
    JumpPower = 50,
    JumpPowerEnabled = false,
    
    -- Fly
    Fly = false,
    FlySpeed = 50,
    FallSpeed = 25,
    
    -- Noclip
    Noclip = false,
    NoclipSpeed = 150,
    NoclipTween = 1,
    
    -- CFrame Speed
    CFrameSpeed = false,
    CFrameSpeedValue = 1,
    
    -- Internal
    PanicModeOption = true, -- User toggle preference
    IsPanicMode = false     -- Actual runtime state
}

local SETTINGS_FOLDER = ReplicatedStorage:WaitForChild("Settings", 10)

-- ============================================================================
-- UI SETUP
-- ============================================================================

local Window = Library:CreateWindow({
    Title = '[Puppy Hub] Bloodlines ðŸ©¸',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2,
    Size = UDim2.fromOffset(700, 600)
})

local Tabs = {
    Visuals = Window:AddTab('Visuals'),
    Movement = Window:AddTab('Movement'),
    Farming = Window:AddTab('Farming'), -- NEW TAB
    Servers = Window:AddTab('Server List'),
    Settings = Window:AddTab('UI Settings'),
}

-- ============================================================================
-- FARMING TAB UI (NEW)
-- ============================================================================
if BossFarm and AutoFarmHandler then
    local FarmLeft = Tabs.Farming:AddLeftGroupbox('Auto Summon & Pickup')
    local FarmRight = Tabs.Farming:AddRightGroupbox('Boss Farm')

    -- Auto Summon Section
    FarmLeft:AddToggle('AutoPickupToggle', {
        Text = 'Auto Pickup Items',
        Default = false,
        Tooltip = 'Automatically picks up Fruits, Trinkets, etc.',
        Callback = function(val)
            AutoFarmHandler.togglePickup(val)
        end
    })
    
    FarmLeft:AddToggle('AutoSummonToggle', {
        Text = 'Auto Fruit Summon',
        Default = false,
        Tooltip = 'Automatically uses Fruit Summoning skill from loadout.',
        Callback = function(val)
            AutoFarmHandler.toggleSummon(val)
        end
    }):AddKeyPicker('AutoSummonKey', {
        Default = 'P',
        Text = 'Toggle Summon',
        Mode = 'Toggle', -- Toggles the boolean state
    })
    
    Options.AutoSummonKey:OnClick(function()
        Toggles.AutoSummonToggle:SetValue(not Toggles.AutoSummonToggle.Value)
    end)
    
    FarmLeft:AddSlider('PickupRange', {
        Text = 'Pickup Range', Default = 50, Min = 10, Max = 100, Rounding = 0,
        Callback = function(val) AutoFarmHandler.Settings.PickupRange = val end
    })

    -- Boss Farm Section
    FarmRight:AddToggle('BossFarmEnabled', {
        Text = 'Enable Boss Farm',
        Default = false,
        Callback = function(val)
            BossFarm.Settings.Enabled = val
            if val then BossFarm.start() else BossFarm.stop() end
        end
    })
    
    FarmRight:AddDropdown('BossSelection', {
        Values = BossFarm.bossDatabase,
        Default = 1,
        Multi = true,
        Text = 'Select Bosses',
        Tooltip = 'Select which bosses to farm',
        Callback = function(val)
            BossFarm.Settings.SelectedBosses = val
        end
    })
    
    FarmRight:AddToggle('ServerHopBoss', {
        Text = 'Hop If No Boss', Default = false,
        Callback = function(val) BossFarm.Settings.ServerHopIfNoBoss = val end
    })
    
    FarmRight:AddToggle('ServerHopChakra', {
        Text = 'Hop On Chakra Sense', Default = false,
        Callback = function(val) BossFarm.Settings.ServerHopIfChakraSense = val end
    })
    
    FarmRight:AddSlider('AttackInterval', {
        Text = 'Attack Speed (s)', Default = 0.5, Min = 0.1, Max = 2, Rounding = 1,
        Callback = function(val) BossFarm.Settings.AttackInterval = val end
    })
    
    FarmRight:AddSlider('SafeHeight', {
        Text = 'Safe Height', Default = 30, Min = 10, Max = 100, Rounding = 0,
        Callback = function(val) BossFarm.Settings.SafeHeightOffset = val end
    })
else
    Tabs.Farming:AddLeftGroupbox('Error'):AddLabel("Farming modules failed to load.")
end

-- ============================================================================
-- MOVEMENT LOGIC (PANIC MODE ENABLED)
-- ============================================================================

-- 1. Panic Check (Chakra Sense - Global Check)
local function checkPanicMode()
    if not State.PanicModeOption then 
        State.IsPanicMode = false
        return 
    end

    local found = false
    
    for _, player in ipairs(Players:GetPlayers()) do
        if SETTINGS_FOLDER then
            local playerSettings = SETTINGS_FOLDER:FindFirstChild(player.Name)
            if playerSettings then
                local sVal = playerSettings:FindFirstChild("CurrentSkill")
                if sVal and type(sVal.Value) == "string" then
                    if string.find(string.lower(sVal.Value), "sense") then
                        found = true
                        break 
                    end
                end
            end
        end
        
        if not found and player.Character then
            for _, child in ipairs(player.Character:GetChildren()) do
                if child:IsA("Tool") and string.find(string.lower(child.Name), "chakra sense") then
                    found = true
                    break
                end
            end
        end
        
        if found then break end
    end
    
    State.IsPanicMode = found
    
    -- Safety shutdown for Farming if panic
    if State.IsPanicMode and BossFarm and BossFarm.Settings.Enabled then
        if BossFarm.Settings.ServerHopIfChakraSense then
             -- Logic handled inside BossFarm module (it monitors chakra sense too)
        else
             -- Temporary pause logic could go here
        end
    end
end

-- 2. WalkSpeed & JumpPower Loop
RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    
    checkPanicMode()
    
    if hum then
        if State.WalkSpeedEnabled and not State.IsPanicMode then
            if hum.WalkSpeed ~= State.WalkSpeed then
                hum.WalkSpeed = State.WalkSpeed
            end
        end
        
        if State.JumpPowerEnabled and not State.IsPanicMode then
            if hum.UseJumpPower then
                if hum.JumpPower ~= State.JumpPower then
                    hum.JumpPower = State.JumpPower
                end
            end
        end
    end
end)

-- 3. Fly Logic
RunService.RenderStepped:Connect(function()
    if not State.Fly or State.IsPanicMode then return end
    
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local cam = Workspace.CurrentCamera
    local velocity = Vector3.new()
    local lookVector = (cam.Focus.p - cam.CFrame.p).Unit
    
    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
        velocity = velocity + Vector3.new(0, State.FlySpeed, 0)
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then
        velocity = velocity + lookVector * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then
        velocity = velocity - lookVector * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then
        velocity = velocity - Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then
        velocity = velocity + Vector3.new(-lookVector.Z, 0, lookVector.X) * State.FlySpeed
    end
    
    velocity = velocity - Vector3.new(0, State.FallSpeed, 0)
    root.Velocity = velocity
end)

-- 4. Noclip Logic
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        if State.Noclip and char and not State.IsPanicMode then
            local hum = char:FindFirstChild("Humanoid")
            local root = char:FindFirstChild("HumanoidRootPart")
            
            if hum and root then
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                for _, v in ipairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
                
                local newpos = root.CFrame + hum.MoveDirection * State.NoclipTween
                TweenService:Create(root, TweenInfo.new(0, Enum.EasingStyle.Linear), {CFrame = newpos}):Play()
            end
        else
            if char then
                local root = char:FindFirstChild("HumanoidRootPart")
                if root then root.CanCollide = true end
            end
        end
        task.wait()
    end
end)

-- 5. CFrame Speed Logic
RunService.RenderStepped:Connect(function()
    if State.CFrameSpeed and not State.IsPanicMode then
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
            local moveDir = char.Humanoid.MoveDirection
            local moveVec = moveDir * (State.CFrameSpeedValue / 10) 
            char.HumanoidRootPart.CFrame = char.HumanoidRootPart.CFrame + moveVec
            char.HumanoidRootPart.Velocity = Vector3.new(0, char.HumanoidRootPart.Velocity.Y, 0)
        end
    end
end)


-- ============================================================================
-- MOVEMENT TAB UI
-- ============================================================================
local MoveGroup = Tabs.Movement:AddLeftGroupbox('Character')
local FlyGroup = Tabs.Movement:AddRightGroupbox('Fly')
local NoclipGroup = Tabs.Movement:AddLeftGroupbox('Noclip')
local CFrameGroup = Tabs.Movement:AddRightGroupbox('CFrame Speed')

MoveGroup:AddToggle('WalkSpeedToggle', {
    Text = 'Enable WalkSpeed', Default = false,
    Callback = function(val) State.WalkSpeedEnabled = val end
})
MoveGroup:AddSlider('WalkSpeedSlider', {
    Text = 'Speed', Default = 16, Min = 16, Max = 45, Rounding = 0,
    Callback = function(val) State.WalkSpeed = val end
})
MoveGroup:AddToggle('PanicModeToggle', {
    Text = 'Auto Panic (Chakra Sense)', Default = true,
    Tooltip = 'Disables movement hacks when someone uses Chakra Sense.',
    Callback = function(val) State.PanicModeOption = val end
})
MoveGroup:AddToggle('JumpPowerToggle', {
    Text = 'Enable JumpPower', Default = false,
    Callback = function(val) State.JumpPowerEnabled = val end
})
MoveGroup:AddSlider('JumpPowerSlider', {
    Text = 'Power', Default = 50, Min = 0, Max = 100, Rounding = 0,
    Callback = function(val) State.JumpPower = val end
})

FlyGroup:AddToggle('FlyToggle', {
    Text = 'Enable Fly', Default = false,
    Callback = function(val) State.Fly = val end
}):AddKeyPicker('FlyKey', { Default = 'F2', NoUI = true, Text = 'Fly Bind' })

FlyGroup:AddSlider('FlySpeed', {
    Text = 'Fly Speed', Default = 50, Min = 10, Max = 250, Rounding = 0,
    Callback = function(val) State.FlySpeed = val end
})
FlyGroup:AddSlider('FallSpeed', {
    Text = 'Fall Speed', Default = 25, Min = 0, Max = 100, Rounding = 0,
    Callback = function(val) State.FallSpeed = val end
})
Options.FlyKey:OnClick(function() Toggles.FlyToggle:SetValue(not Toggles.FlyToggle.Value) end)

NoclipGroup:AddToggle('NoclipToggle', {
    Text = 'Enable Noclip', Default = false,
    Callback = function(val) State.Noclip = val end
}):AddKeyPicker('NoclipKey', { Default = 'F3', NoUI = true, Text = 'Noclip Bind' })
Options.NoclipKey:OnClick(function() Toggles.NoclipToggle:SetValue(not Toggles.NoclipToggle.Value) end)
NoclipGroup:AddSlider('NoclipSpeed', {
    Text = 'Move Speed', Default = 150, Min = 100, Max = 275, Rounding = 0,
    Callback = function(val) State.NoclipSpeed = val end
})
NoclipGroup:AddSlider('TweenSpeed', {
    Text = 'Tween Speed', Default = 1, Min = 0, Max = 5, Rounding = 1,
    Callback = function(val) State.NoclipTween = val end
})

CFrameGroup:AddToggle('CFrameToggle', {
    Text = 'Enable CFrame Speed', Default = false,
    Callback = function(val) State.CFrameSpeed = val end
}):AddKeyPicker('CFrameKey', { Default = 'F4', NoUI = true, Text = 'CF Speed Bind' })
Options.CFrameKey:OnClick(function() Toggles.CFrameToggle:SetValue(not Toggles.CFrameToggle.Value) end)
CFrameGroup:AddSlider('CFrameSpeed', {
    Text = 'Speed Factor', Default = 1, Min = 1, Max = 250, Rounding = 0,
    Callback = function(val) State.CFrameSpeedValue = val end
})


-- ============================================================================
-- VISUALS TAB
-- ============================================================================
local PlayerGroup = Tabs.Visuals:AddLeftGroupbox('Player ESP')
local ItemGroup = Tabs.Visuals:AddRightGroupbox('World ESP')
local MiscGroup = Tabs.Visuals:AddLeftGroupbox('Misc')

PlayerGroup:AddToggle('PlayerESP', {
    Text = 'Enable Player ESP', Default = false,
    Tooltip = 'Shows players, weapons, and health.',
    Callback = function(val)
        if PlayerESPHandler then
            if val then PlayerESPHandler:enable() else PlayerESPHandler:disable() end
        end
    end
})

PlayerGroup:AddToggle('ObserveUI', {
    Text = 'Observe UI', Default = false,
    Callback = function(val)
        if ObserveUI then if val then ObserveUI:enable() else ObserveUI:disable() end end
    end
})

PlayerGroup:AddToggle('ChatLogs', {
    Text = 'Chat Logs', Default = false,
    Callback = function(val)
        if ChatLog then if val then ChatLog:enable() else ChatLog:disable() end end
    end
})

ItemGroup:AddToggle('MobESP', {
    Text = 'Mob ESP (Combat)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleMobs(val) end end
})
ItemGroup:AddToggle('NpcESP', {
    Text = 'NPC ESP (Dialog)', Default = false,
    Callback = function(val) if MobESPHandler then MobESPHandler:toggleNPCs(val) end end
})
ItemGroup:AddDivider()
ItemGroup:AddToggle('TrinketESP', {
    Text = 'Trinket ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Trinket", val) end end
})
ItemGroup:AddToggle('FruitESP', {
    Text = 'Fruit ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Fruit", val) end end
})
ItemGroup:AddToggle('GemESP', {
    Text = 'Gem ESP', Default = false,
    Callback = function(val) if ItemESPHandler then ItemESPHandler:toggleCategory("Gem", val) end end
})
ItemGroup:AddToggle('ChakraESP', {
    Text = 'Chakra Point ESP', Default = false,
    Callback = function(val) if ChakraESPHandler then if val then ChakraESPHandler:enable() else ChakraESPHandler:disable() end end end
})
ItemGroup:AddToggle('CorruptedESP', {
    Text = 'Corrupted Point ESP', Default = false,
    Callback = function(val) if CorruptedESPHandler then if val then CorruptedESPHandler:enable() else CorruptedESPHandler:disable() end end end
})

MiscGroup:AddToggle('TransTrailToggle', {
    Text = 'Trans Flag Trail', Default = false,
    Callback = function(val) if TransTrail then if val then TransTrail:enable() else TransTrail:disable() end end end
})
MiscGroup:AddToggle('NoFogToggle', {
    Text = 'No Fog', Default = false,
    Callback = function(val) if NoFog then if val then NoFog:enable() else NoFog:disable() end end end
})


-- ============================================================================
-- API SERVER BROWSER
-- ============================================================================
local ServerGroup = Tabs.Servers:AddLeftGroupbox('Server Browser (API)')
local GAME_ID = 10266164381

local function joinServer(id)
    local events = ReplicatedStorage:FindFirstChild("Events")
    local dataEvent = events and events:FindFirstChild("DataEvent")
    if dataEvent then
        print("[PuppyHub] Teleporting to server:", id)
        dataEvent:FireServer("ServerTeleport", id, 14)
    else
        warn("[PuppyHub] Could not find DataEvent for teleport!")
    end
end

local StatusLabel = ServerGroup:AddLabel("Click 'Refresh' to load servers.")
local serverScroll = Library:Create('ScrollingFrame', {
    Name = "ServerListScroll",
    Size = UDim2.new(1, -4, 0, 400),
    ZIndex = 6,
    Parent = ServerGroup.Container,
    BackgroundColor3 = Library.BackgroundColor,
    BorderColor3 = Library.OutlineColor,
    BorderMode = Enum.BorderMode.Inset,
    ScrollBarThickness = 6,
    ScrollBarImageColor3 = Library.AccentColor,
})
Library:Create('UIListLayout', {
    Padding = UDim.new(0, 5),
    FillDirection = Enum.FillDirection.Vertical,
    SortOrder = Enum.SortOrder.LayoutOrder,
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    Parent = serverScroll,
})

local isFetching = false
local function fetchServers()
    if isFetching then return end
    isFetching = true
    for _, child in ipairs(serverScroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    task.spawn(function()
        local allServers = {}
        local cursor = ""
        local pageNum = 1
        local continueFetching = true

        while continueFetching do
            StatusLabel:SetText("Fetching Page " .. pageNum .. "...")
            local success, response = pcall(function()
                local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
                local url = string.format("https://roproxy-production-0200.up.railway.app/games/v1/games/%d/servers/0?sortOrder=2&excludeFullGames=false&limit=100", GAME_ID)
                if cursor ~= "" then url = url .. "&cursor=" .. cursor end
                if requestFunc then return requestFunc({Url = url, Method = "GET"}).Body else return game:HttpGet(url) end
            end)
            if not success or not response then StatusLabel:SetText("Failed to fetch page " .. pageNum) continueFetching = false break end
            local jsonSuccess, data = pcall(HttpService.JSONDecode, HttpService, response)
            if not jsonSuccess or not data or not data.data then StatusLabel:SetText("Failed to parse API data.") continueFetching = false break end
            for _, s in ipairs(data.data) do table.insert(allServers, s) end
            if data.nextPageCursor and data.nextPageCursor ~= "" then cursor = data.nextPageCursor pageNum = pageNum + 1 task.wait(0.1) else continueFetching = false end
        end
        
        if #allServers > 0 then
            StatusLabel:SetText("Sorting " .. #allServers .. " servers...")
            table.sort(allServers, function(a, b) return (a.playing or 0) > (b.playing or 0) end)
            StatusLabel:SetText(string.format("Loaded %d servers.", #allServers))
            for _, server in ipairs(allServers) do
                local text = string.format("%d/%d Plrs | FPS: %.0f | Ping: %d", server.playing, server.maxPlayers, server.fps or 0, server.ping or 0)
                local btn = Library:Create('TextButton', { Parent = serverScroll, Text = text, Size = UDim2.new(1, -10, 0, 30), BackgroundColor3 = Library.MainColor, TextColor3 = Library.FontColor, Font = Library.Font, TextSize = 14, ZIndex = 10 })
                Library:OnHighlight(btn, btn, { BorderColor3 = 'AccentColor' }, { BorderColor3 = 'OutlineColor' })
                btn.MouseButton1Click:Connect(function() joinServer(server.id) end)
            end
            task.wait(0.1)
            local layout = serverScroll:FindFirstChildOfClass("UIListLayout")
            if layout then serverScroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y) end
        else
            StatusLabel:SetText("No servers found or API error.")
        end
        isFetching = false
    end)
end
ServerGroup:AddButton('Refresh Servers', fetchServers)
task.delay(1, fetchServers)

-- ============================================================================
-- UI SETTINGS & INIT
-- ============================================================================
local MenuGroup = Tabs.Settings:AddLeftGroupbox('Menu')
MenuGroup:AddButton('Unload', function() Library:Unload() end)
MenuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { Default = 'Insert', NoUI = true, Text = 'Menu keybind' })
Library.ToggleKeybind = Options.MenuKeybind

ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
ThemeManager:SetFolder('PuppyHub')
SaveManager:SetFolder('PuppyHub/Bloodlines')
ThemeManager:ApplyToTab(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

print("[Puppy Hub] Bloodlines Edition Loaded")